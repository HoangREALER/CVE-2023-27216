#!/bin/sh

TimeFlag=1
StartTime=`date +%s`

while [ 1 = 1 ]
do
	/userfs/bin/tcapi set WLan_Common ReadFlag 0
	channel=`/userfs/bin/tcapi get WLan_Common Channel`
	/userfs/bin/tcapi set WLan_Common ReadFlag 1
	/userfs/bin/tcapi set WLan_Common ReadFlag 0
	enable=`/userfs/bin/tcapi get WLan_Entry0 EnableSSID`
	/userfs/bin/tcapi set WLan_Common ReadFlag 1
	/userfs/bin/tcapi set WLan_Common ReadFlag 0
	apon=`/userfs/bin/tcapi get WLan_Common APOn`
	/userfs/bin/tcapi set WLan_Common ReadFlag 1
	/userfs/bin/tcapi set WLan_Common ReadFlag 0
	enableautoperiod=`/userfs/bin/tcapi get WLan_Common EnableAutoChannelPeriod`
	/userfs/bin/tcapi set WLan_Common ReadFlag 1
	/userfs/bin/tcapi set WLan_Common ReadFlag 0
	tmp=`/userfs/bin/tcapi get WLan_Common AutoChannelPeriod`
	/userfs/bin/tcapi set WLan_Common ReadFlag 1
	AutoChannelPeriod=3600
	if [ "$tmp" = "no attribute information" ]; then
		AutoChannelPeriod=3600
	else
		AutoChannelPeriod=$tmp
	fi
	
	if [ "$enableautoperiod" = "no attribute information" ]; then
		enableautoperiod=1
	fi

	if [ "$channel" = "0" ] && [ "$enable" = "1" ] && [ "$apon" = "1" ] && [ "$enableautoperiod" = "1" ]; then
		if [ $TimeFlag -le 0 ]; then
			DATA_FILE="/var/tmp/stainfott.cfg"
			/userfs/bin/iwpriv ra0 ar9_show stainfott > /var/tmp/stainfott.cfg
			TOTAL_LINE=`sed -n "$=" $DATA_FILE`
			TOTAL_LINE=`expr $TOTAL_LINE - 3`
			echo $TOTAL_LINE 
			if [ $TOTAL_LINE -le 0 ]; then
				echo "== Execute auto channel"
				/userfs/bin/iwpriv ra0 set AutoChannelSel=2
			fi
#			/userfs/bin/tcapi set WLan_Common ReadFlag 0
#			tmp=`/userfs/bin/tcapi get WLan_Common AutoChannelPeriod`
#			/userfs/bin/tcapi set WLan_Common ReadFlag 1
			echo $tmp 
			AutoChannelPeriod=3600
			StartTime=`date +%s`
			if [ "$tmp" = "no attribute information" ]; then
				AutoChannelPeriod=3600
			else
				AutoChannelPeriod=$tmp
			fi
			TimeFlag=$AutoChannelPeriod
			echo "++++++auto channel"
		else
			CurrTime=`date +%s`
			CSTime=`expr $CurrTime - $StartTime`
			TimeFlag=`expr $AutoChannelPeriod - $CSTime`
		fi
		echo AutoChannelPeriod $AutoChannelPeriod
		echo CurrTime $CurrTime
		echo StartTime $StartTime
		echo TimeFlag $TimeFlag
	fi
    sleep 120
done

