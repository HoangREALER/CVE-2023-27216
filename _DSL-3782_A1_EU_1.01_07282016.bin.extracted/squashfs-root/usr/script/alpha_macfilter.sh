#!/bin/sh

setIptableCmd()
{
iptables -t filter -A macfilter_chain $TIME_ARG -m mac --mac-source $MAC -j $TARGET
}

. /usr/script/alpha_fun_lib.sh

CONF=/tmp/etc/macfilter.conf

if [ ! -f $CONF ]; then
#  echo "no conf"
  exit 0
fi

#Get mode
TMP=`sed -n 's/^.*mode=//gp' $CONF`
if [ -z "$TMP" ]; then
  exit 0
fi
MODE=$TMP
#echo "mode is $MODE"
case "$MODE" in
  "black")
    TARGET="DROP"
    ;;
  "white")
    TARGET="RETURN"
    ;;
  "disable")
    iptables -t filter -F macfilter_chain
    exit 0
    ;;
  *)
    exit 0
esac

#Get number
TMP=`sed -n 's/^.*num=//gp' $CONF`
if [ -z "$TMP" ]; then
  exit 0
fi
NUM=$TMP
if [ "$NUM" -eq "0" ]; then
  iptables -t filter -F macfilter_chain
  if [ "$MODE" = "white" ]; then
    iptables -t filter -A macfilter_chain -j DROP
  fi
  exit 0
fi
#echo "num is $NUM"

#Clear iptable chain
iptables -t filter -F macfilter_chain

#Get entry
i=0
MAX_NUM=`expr $i + $NUM`
while [ "$i" -lt "$MAX_NUM" ];do
  MAC=`sed -n "s/^.*entry${i}=//gp" $CONF`
#  echo "MAC is $MAC TARGET is $TARGET"
  if [ -z "$MAC" ]; then
    exit 0
  fi

 #Get time
#  TMP=`sed -n "s/^.*time_flag${i}=//gp" $CONF`
#  TIME_ARG=""
#  if [ "$TMP" -eq "1" ]; then
#    TMP=`sed -n "s/^.*start_time${i}=//gp" $CONF`
#    if [ -z "$TMP" ]; then
#      exit 0
#    fi
#    START=$TMP
#    TMP=`sed -n "s/^.*stop_time${i}=//gp" $CONF`
#    if [ -z "$TMP" ]; then
#      exit 0
#    fi
#    STOP=$TMP
#    TMP=`sed -n "s/^.*days${i}=//gp" $CONF`
#    if [ -z "$TMP" ]; then
#      exit 0
#    fi
#    DAYS=$TMP
#    TIME_ARG=`echo "-m time --timestart $START --timestop $STOP --days $DAYS"`
#  fi
#  echo "TIME_ARG is $TIME_ARG"

#  iptables -t filter -A macfilter_chain $TIME_ARG -m mac --mac-source $MAC -j $TARGET

  #Get schedule
  SCH_NAME=`sed -n "s/SCH${i}=//gp" $CONF`
  if [ -n "$SCH_NAME" ]; then
    setIptableWithSch $SCH_NAME;
  else
    TIME_ARG=""
    setIptableCmd;
  fi

  i=`expr $i + 1`
done

if [ "$MODE" = "white" ]; then
  iptables -t filter -A macfilter_chain -j DROP
fi

