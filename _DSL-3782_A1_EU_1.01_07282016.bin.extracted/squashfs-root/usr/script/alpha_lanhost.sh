#!/bin/sh

HOST_FILE=/var/tmp/host.tmp
MAC_FILE=/var/tmp/hmac.tmp
RET_FILE=/var/tmp/LanHost
INF_SCRIPT=/usr/script/alpha_macfinder.sh
INF_RET=/var/tmp/inf_ret.tmp
LAN_STATE=/proc/tc3162/eth_port_status
PORT_STATE=/var/tmp/ports
HOST_INF=br0


#	Get arp table
arp -an -i $HOST_INF > $HOST_FILE

#	Remove incomplete MAC first
sed -i /incomplete/d $HOST_FILE

#	Get arp entry number
TOTAL_LINE=`sed -n "$=" $HOST_FILE`

#	Check file
if [ "$TOTAL_LINE" -eq "0" ]; then
	echo "No host data"
	echo "0 0 0" > $RET_FILE
	exit 1
fi
if [ "$TOTAL_LINE" -eq "1"  ]; then
	LINE=`sed -n "/no match/p" $HOST_FILE`
	if [ -n "$LINE" ];then
		echo "No valid host"
		echo "0 0 0" > $RET_FILE
		exit 1
	fi
fi

#       Create mac list
FG=0
while [ "$TOTAL_LINE" -gt "0"  ];do
	# Get the 1st line
	LINE=`sed -n 1p $HOST_FILE`
	if [ -z "$LINE" ]; then
		echo "No mac data"
		echo "0 0 0" > $RET_FILE
		exit 1
	fi
	MAC=`echo "${LINE}" | sed -n 's/^.*at //gp' | sed -n 's/ .*$//gp'`
#	echo "MAC is $MAC"
	 if [ -n "$MAC" ]; then
		sed -i /${MAC}/d $HOST_FILE
		TOTAL_LINE=`sed -n "$=" $HOST_FILE`
		if [ "$FG" -eq "0" ]; then
			echo "$MAC" > $MAC_FILE
			FG=1
		else
			echo "$MAC" >> $MAC_FILE
		fi
	else
		sed -i 1d $HOST_FILE
		TOTAL_LINE=`expr $TOTAL_LINE - 1`
	fi
done
rm -f $HOST_FILE

#	Count MAC
TOTAL_LINE=`sed -n "$=" $MAC_FILE`
if [ "$TOTAL_LINE" -eq "0" ]; then
	echo "0 0 0" > $RET_FILE
	exit 0
fi

#	Check port state
if [ -f "$LAN_STATE" ]; then
	FG=1
	# Change row to line
	sed -n 's/ /\n/gp' $LAN_STATE > $PORT_STATE
	if [ ! -f "${PORT_STATE}" ]; then
		FG=0
	else
		TMP=`sed -n 1p $PORT_STATE`
		if [ -z "$TMP" ]; then
			FG=0
		fi
	fi
else
	FG=0
fi
#echo "FG is $FG"

#	Loop MAC
TOTAL_HOST=$TOTAL_LINE
LAN_HOST=0
WL_HOST=0
CUR=1
while [ "$CUR" -le "$TOTAL_LINE" ];do
	MAC=`sed -n "${CUR}p" $MAC_FILE`
	if [ -z "$MAC" ]; then
		TOTAL_HOST=`expr $TOTAL_HOST - 1`
		CUR=`expr $CUR + 1`
		continue
	fi
#	echo "Get MAC $MAC"
	# Get interface type of the MAC
	$INF_SCRIPT $INF_RET $MAC
	if [ ! -f "$INF_RET" ]; then
		echo "Get inf type fail"
		TOTAL_HOST=`expr $TOTAL_HOST - 1`
		CUR=`expr $CUR + 1`
		continue
	fi
	TYPE=`sed -n /=L/p $INF_RET`
	if [ -n "$TYPE" ]; then
		if [ "${FG}" -eq "1" ]; then
			# Get port number
			LAN_INDEX=`sed -n 's/^.*L//gp' $INF_RET`
			#echo "in is $LAN_INDEX"
			TMP=`sed -n "${LAN_INDEX}p" $PORT_STATE`
			#echo "sta is $TMP"
			if [ "$TMP" -eq "1" ]; then
				LAN_HOST=`expr $LAN_HOST + 1`
			else
				TOTAL_HOST=`expr $TOTAL_HOST - 1`
			fi
		else
			LAN_HOST=`expr $LAN_HOST + 1`
		fi
	else
		WL_HOST=`expr $WL_HOST + 1`
	fi
	rm -f $INF_RET

	CUR=`expr $CUR + 1`
done
echo "$TOTAL_HOST $LAN_HOST $WL_HOST" > $RET_FILE

rm -f $MAC_FILE
rm -f $PORT_STATE
exit 0
