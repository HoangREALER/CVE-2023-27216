#!/bin/sh

while [ 1 = 1 ]
do
	sleep 30
	
	/userfs/bin/tcapi set WLan_Common ReadFlag 0
	SCH_NAME=`/userfs/bin/tcapi get WLan_Entry0 SCH`
	/userfs/bin/tcapi set WLan_Common ReadFlag 1
	SCH_RULE_NAME=`/userfs/bin/tcapi get Schedule_Entry0 Name`
	/userfs/bin/tcapi set WLan_Common ReadFlag 0
	ENABLED=`/userfs/bin/tcapi get WLan_Entry0 EnableSSID`
	/userfs/bin/tcapi set WLan_Common ReadFlag 1
	
	if [ -z "$SCH_NAME" ] || [ "$SCH_NAME" = "-" ] || [ "$SCH_NAME" = "connection error" ] || [ "$SCH_NAME" = "no attribute information" ]; then
		continue
	fi
	
	i=0
	while [ "$SCH_NAME" != "$SCH_RULE_NAME" ]
	do
		i=`expr $i + 1`	
		SCH_RULE_NAME=`/userfs/bin/tcapi get Schedule_Entry$i Name`
		if [ "$i" -gt "9" ]; then
			/userfs/bin/tcapi set WLan_Entry0 SCH -
			continue 2
		fi
	done

	RULE=`/userfs/bin/tcapi get Schedule_Entry$i Time`

	if [ -z "$RULE" ] || [ "$RULE" = "-" ] || [ "$RULE" = "connection error" ] || [ "$RULE" = "no attribute information" ]; then
		continue
	fi
	
	CUR_TIME=`date`
	WEEKDAY=${CUR_TIME%%' '*}

	case "$WEEKDAY" in
		"Mon")
			day=0
		;;
		"Tue")
			day=1
		;;
		"Wed")
			day=2
		;;
		"Thu")
			day=3
		;;
		"Fri")
			day=4
		;;	
		"Sat")
			day=5
		;;	
		"Sun")
			day=6
		;;
		*)
			day=0
		;;							
	esac

	hour=${CUR_TIME%%\:*}
	hour=${hour##*' '}
	hour=`expr $hour + 0`
	
	CUR_SCH=`expr $day \* 24`
	CUR_SCH=`expr $CUR_SCH + $hour`

	FLAG=0
	i=1
	SCH_TIME=`echo "$RULE" | awk -F"[-]" '{print $1}'`
	while [ -n "$SCH_TIME" ]
	do
		if [ "$CUR_SCH" = "$SCH_TIME" ]; then
			FLAG=1
			break
		fi
		i=`expr $i + 1`
		SCH_TIME=`echo "$RULE" | awk -F"[-]" '{print $'$i'}'`
	done

	if [ "$FLAG" = "1" ]; then
		if [ "$ENABLED" = "0" ]; then
			/userfs/bin/tcapi set WLan_Entry0 EnableSSID 1
			/userfs/bin/tcapi commit WLan_Entry0
			echo "WiFi 2.4G start by scheduled!"
		fi
	else
		if [ "$ENABLED" = "1" ]; then
			/userfs/bin/tcapi set WLan_Entry0 EnableSSID 0
			/userfs/bin/tcapi commit WLan_Entry0
			echo "WiFi 2.4G stop by scheduled!"
		fi
	fi

done

