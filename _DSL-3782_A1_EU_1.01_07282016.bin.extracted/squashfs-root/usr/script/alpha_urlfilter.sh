#!/bin/sh

setIptableCmd()
{
iptables -t filter -A url_filter_chain $TIME_ARG -m string --url $URL -j $TARGET
}

. /usr/script/alpha_fun_lib.sh

CONF=/tmp/etc/urlfilter.conf

if [ ! -f $CONF ]; then
# echo "no conf"
  exit 0
fi


#Get mode
TMP=`sed -n 's/^.*mode=//gp' $CONF`
if [ -z "$TMP" ]; then
  exit 0
fi
MODE=$TMP
#echo "mode is $MODE"
case "$MODE" in
  "black")
    TARGET="DROP"
    ;;
  "white")
    TARGET="RETURN"
    ;;
  "disable")
    iptables -t filter -F url_filter_chain
    exit 0
    ;;
  *)
    exit 0
esac

#Get number
TMP=`sed -n 's/^.*num=//gp' $CONF`
if [ -z "$TMP" ]; then
  exit 0
fi
NUM=$TMP
if [ "$NUM" -eq "0" ]; then
  iptables -t filter -F url_filter_chain
  if [ "$MODE" = "white" ]; then
    iptables -t filter -A url_filter_chain -m string --http_req -j LOG --log-level debug --log-prefix DRP:UrlFilter:
    iptables -t filter -A url_filter_chain -m string --http_req -j DROP
  fi
  exit 0
fi
# echo "num is $NUM"
echo "target is "$TARGET
#Clear iptable chain
iptables -t filter -F url_filter_chain

#Get entry
i=0
# MAX_NUM=`expr $i + $NUM \* 2`
while [ "$i" -lt "$NUM" ];do
#  URL=`sed -n "${i}p" $CONF | sed 's/^.*entry=//g'`
	URL=`sed -n "s/entry${i}=//gp" $CONF`
  if [ -z "$URL" ]; then
    exit 0
  fi
#  echo "URL is $URL TARGET is $TARGET"
  if [ "$TARGET" = "DROP"  ];then
    iptables -t filter -A url_filter_chain -m string --url $URL -j LOG --log-level debug --log-prefix DRP:UrlFilter:
  fi
  
  #Get schedule
  SCH_NAME=`sed -n "s/sch${i}=//gp" $CONF`
  if [ -n "$SCH_NAME" ]; then
    setIptableWithSch $SCH_NAME;
  else
    TIME_ARG=""
    setIptableCmd;
  fi  

  i=`expr $i + 1`
done

if [ "$MODE" = "white" ]; then
  iptables -t filter -A url_filter_chain -m string --http_req -j LOG --log-level debug --log-prefix DRP:UrlFilter:
  iptables -t filter -A url_filter_chain -m string --http_req -j DROP
fi

