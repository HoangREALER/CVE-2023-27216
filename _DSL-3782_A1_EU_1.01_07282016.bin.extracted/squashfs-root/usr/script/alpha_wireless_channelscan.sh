#!/bin/sh

DATA_FILE="/var/tmp/eapinfochscan.cfg"
/userfs/bin/iwpriv ra0 set SiteSurvey=1
sleep 3
/userfs/bin/iwpriv ra0 ar9_show eapinfott > /var/tmp/eapinfochscan.cfg

#Clear old info
/userfs/bin/tcapi unset Info_WifiChScan

#	Check data file
if [ -z "$DATA_FILE" ]; then
	echo "No data file to process"
	exit 1
fi
if [ ! -f "$DATA_FILE" ]; then
	echo "$DATA_FILE no exist"
	exit 1
fi
#	Get line number of data file
TOTAL_LINE=`sed -n "$=" $DATA_FILE`
TOTAL_LINE=`expr $TOTAL_LINE - 1`

/userfs/bin/tcapi set Info_WifiChScan EapNum `expr $TOTAL_LINE - 1`

#	Loop data line
CUR_LINE=2
if [ "$TOTAL_LINE" -lt "0" ];then
	/userfs/bin/tcapi set Info_WifiChScan EapStatus Error
elif [ "$TOTAL_LINE" = "0" ];then
	/userfs/bin/tcapi set Info_WifiChScan EapStatus None
else
	/userfs/bin/tcapi set Info_WifiChScan EapStatus Requested
fi

while [ "$CUR_LINE" -le "$TOTAL_LINE" ];do
	# Get the line
	LINE=`sed -n "${CUR_LINE}p" $DATA_FILE`
	if [ -z "$LINE" ]; then
		echo "Invalid line"
		exit 1
	fi
#	echo "LINE is $LINE"
	# Get Ch
	Ch=`echo "${LINE}" | sed -n 's/^.*Ch=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$Ch" ]; then
		echo "No Ch"
		exit 1
	fi
#	echo "Ch is $Ch"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`Ch $Ch
	
	# Get SSID
	SSID=`echo "${LINE}" | sed -n 's/^.*SSID=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$SSID" ]; then
		echo "No SSID"
		#exit 1
	fi
#	echo "SSID is $SSID"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`SSID $SSID
	
	# Get BID
	BID=`echo "${LINE}" | sed -n 's/^.*BID=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$BID" ]; then
		echo "No BID"
		exit 1
	fi
#	echo "BID is $BID"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`BID $BID
	
	# Get Security
	Security=`echo "${LINE}" | sed -n 's/^.*Security=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$Security" ]; then
		echo "No Security"
		exit 1
	fi
#	echo "Security is $Security"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`Security $Security
	
# Get Rssi
	Rssi=`echo "${LINE}" | sed -n 's/^.*Rssi=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$Rssi" ]; then
		echo "No Rssi"
		exit 1
	fi
#	echo "Rssi is $Rssi"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`Rssi $Rssi
	
	# Get Siganl
	Siganl=`echo "${LINE}" | sed -n 's/^.*Siganl=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$Siganl" ]; then
		echo "No Siganl"
		exit 1
	fi
#	echo "Siganl is $Siganl"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`Siganl $Siganl
	
	# Get WMode
	WMode=`echo "${LINE}" | sed -n 's/^.*WMode=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$WMode" ]; then
		echo "No WMode"
		exit 1
	fi
#	echo "WMode is $WMode"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`WMode $WMode
	
	# Get ExtCH
	ExtCH=`echo "${LINE}" | sed -n 's/^.*ExtCH=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$ExtCH" ]; then
		echo "No ExtCH"
		exit 1
	fi
#	echo "ExtCH is $ExtCH"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`ExtCH $ExtCH
	
	# Get WPS
	WPS=`echo "${LINE}" | sed -n 's/^.*WPS=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$WPS" ]; then
		echo "No WPS"
		exit 1
	fi
#	echo "WPS is $WPS"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`WPS $WPS

	# Get BW
	BW=`echo "${LINE}" | sed -n 's/^.*BW=//gp' | sed -n 's/;.*$//gp'`
	if [ -z "$BW" ]; then
		echo "No BW"
		exit 1
	fi
#	echo "BW is $BW"
	/userfs/bin/tcapi set Info_WifiChScan Eap`expr $CUR_LINE - 2`BW $BW

	CUR_LINE=`expr $CUR_LINE + 1`
done

EN=`/userfs/bin/tcapi get Info_WifiChScan EapNum`

if [ "$EN" -gt "0" ];then
	/userfs/bin/tcapi set Info_WifiChScan EapStatus Complete
fi
