var maxRule = 64;
var pvcRule = 8;
var pvcMaxRule = 64;
var weekList = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

var protocol=new Array("","Both","TCP","UDP","ICMP");
var sourceinf_dsl=new Array("PVC1","PVC2","PVC3","PVC4","PVC5","PVC6","PVC7","PVC8","PTM","","WAN");
var sourceinf_ethernet=new Array("","Connection1","Connection2","Connection3");

var filterAction=new Array("","<font color=blue>Allow</font>","<font color=red>"+m_comm_Deny+"</font>");
var macAction=new Array("","<font color=blue>Active</font>","<font color=red>"+m_comm_Inactive+"</font>");

var VirtualServerList = new Array();

var ruleListNo = [0,1,2,3,4,5,6,7];

var Nempty = 0;
for( var z = 0; z < maxRule; z ++) {		
	var virtual_localip = eval("virtual"+z+"localip");
	if(virtual_localip != "N/A") {
		var virtual_active = eval("virtual"+z+"active");
		var virtual_name = eval("virtual"+z+"name");
		var virtual_local_sport = eval("virtual"+z+"local_sport");
		var virtual_local_eport = eval("virtual"+z+"local_eport");
		var virtual_startport = eval("virtual"+z+"startport");
		var virtual_endport = eval("virtual"+z+"endport");
		var virtual_protocol = eval("virtual"+z+"protocol");
		var virtual_schedule = eval("virtual"+z+"schedule");
		
		VirtualServerList.push([virtual_active,virtual_name,virtual_localip,virtual_local_sport,virtual_local_eport,virtual_startport,virtual_endport,virtual_protocol,virtual_schedule]);
		Nempty++;
	} else {
		VirtualServerList.push(["","","","","","","","",""]);
	}
}

var maxScheduleRule = 10;
var ScheduleCount = 0;
var ScheduleList = new Array();	
CountSchedule();
function CountSchedule() {
	for(var i = 0; i < maxScheduleRule; i++) {
		var port_name = eval("port"+i+"_name");
		if(port_name != "N/A") {				
			ScheduleList.push(port_name);
			ScheduleCount ++;
		} 
		else {
			ScheduleList.push("");
		}
	}
}

var pvc_enable = new Array();
for(var i = 0; i < pvcRule; i++) {
	var pvc_en = eval("PVC"+i+"_Enable");
	if(pvc_en != "N/A") 
		pvc_enable.push(pvc_en);
	else
		pvc_enable.push("");
}

var pvc_active = new Array();
for(var i = 0; i < pvcRule; i++) {
	var pvc_ac = eval("PVC"+i+"_active");
	if(pvc_ac != "N/A") 
		pvc_active.push(pvc_ac);
	else
		pvc_active.push("");
}

var wan10_pvc_enable = new Array();
for(var i = 0; i < pvcRule; i++) {
	var pvc_en = eval("WAN10_PVC"+i+"_Enable");
	if(pvc_en != "N/A") 
		wan10_pvc_enable.push(pvc_en);
	else
		wan10_pvc_enable.push("");
}

var wan10_pvc_active = new Array();
for(var i = 0; i < pvcRule; i++) {
	var pvc_ac = eval("WAN10_PVC"+i+"_active");
	if(pvc_ac != "N/A") 
		wan10_pvc_active.push(pvc_ac);
	else
		wan10_pvc_active.push("");
}

var wan8_pvc_enable = new Array();
for(var i = 0; i < pvcRule; i++) {
	var pvc_en = eval("WAN8_PVC"+i+"_Enable");
	if(pvc_en != "N/A") 
		wan8_pvc_enable.push(pvc_en);
	else
		wan8_pvc_enable.push("");
}

var wan8_pvc_active = new Array();
for(var i = 0; i < pvcRule; i++) {
	var pvc_ac = eval("WAN8_PVC"+i+"_active");
	if(pvc_ac != "N/A") 
		wan8_pvc_active.push(pvc_ac);
	else
		wan8_pvc_active.push("");
}

var upnpRuleList = [];
for (var i = 0; i < upnp_CommonNum; i++) {
	var rule_dport = eval("upnpRule" + i + "_dport");
	var rule_sip = eval("upnpRule" + i + "_sip");
	var rule_sport = eval("upnpRule" + i + "_sport");
	var rule_protocol = eval("upnpRule" + i + "_protocol");
	var upnprule = [];
	upnprule.push(rule_dport);
	upnprule.push(rule_sip);
	upnprule.push(rule_sport);
	upnprule.push(rule_protocol);
	upnpRuleList.push(upnprule);
}

function getInterface() {
	var f = document.getElementById("inter");
	f.options.length = 0;

	if(TransMode == "ATM"){
		for(var j = 0; j < ruleListNo.length; j++) {
			var i = ruleListNo[j];
			if(pvc_active[i] == "Yes" && pvc_enable[i] == "Enable") {
				f.options.add(new Option("PVC"+(i+1), i));
			}
		}
	}
	else if(TransMode == "PTM"){
		for(var j = 0; j < ruleListNo.length; j++) {
			var i = ruleListNo[j];
			if(wan8_pvc_active[i] == "Yes" && wan8_pvc_enable[i] == "Enable") {
				f.options.add(new Option("PTM", 8));
				break;
			}
		}
	}
}

function getInterfaceEdit() {
	var f = document.getElementById("inner_display");
	f.options.length = 0;

	if(TransMode == "ATM"){
		for(var j = 0; j < ruleListNo.length; j++) {
			var i = ruleListNo[j];
			if(pvc_active[i] == "Yes" && pvc_enable[i] == "Enable") {
				f.options.add(new Option("PVC"+(i+1), i));
			}
		}
	}
	else if(TransMode == "PTM"){
		for(var j = 0; j < ruleListNo.length; j++) {
			var i = ruleListNo[j];
			if(wan8_pvc_active[i] == "Yes" && wan8_pvc_enable[i] == "Enable") {
				f.options.add(new Option("PTM", 8));
				break;
			}
		}
	}
}

function InitInterface() {
	switch(parseInt($("#inner_display").val())){
		case 0:
		case 1:
		case 2:
		case 3:
		case 4:
		case 5:
		case 6:
		case 7:
			document.getElementById("Service_Num").style.display = "none";
			break;
		case 8:
			document.getElementById("Service_Num").style.display = "";
			var ser = document.getElementById("service");
			ser.options.length = 0;
			for(var j = 0; j < ruleListNo.length; j++) {
				var i = ruleListNo[j];
				if(wan8_pvc_active[i] == "Yes" && wan8_pvc_enable[i] == "Enable") {
					ser.options.add(new Option((i+1), i));
				}
			}
			break;
		case 10:
			document.getElementById("Service_Num").style.display = "";
			var ser = document.getElementById("service");
			ser.options.length = 0;
			for(var j = 0; j < ruleListNo.length; j++) {
				var i = ruleListNo[j];
				if(wan10_pvc_active[i] == "Yes" && wan10_pvc_enable[i] == "Enable") {
					ser.options.add(new Option((i+1), i));
				}
			}
			break;
	}
}

function ChangeInterface(){
	$("#buttonType").val("change");
	
	$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey){
		$("#sessionKey").val(sessionKey);	
		setTimeout('$.post("/cgi-bin/New_GUI/VirtualServer.asp", $("form").serialize(), function(){self.location.href = self.location.href;});', 300);
	});
}

function gen_table() {
	var str = "";
	if(Nempty > 0) {
		var v_inter = parseInt(nat_pvc);
		for(var z = 0; z < maxRule; z++) {	
			if(VirtualServerList[z][2] != "") {
				str+="<tr>";
				str+="<td align=center>" +macAction[(VirtualServerList[z][0]=="Yes"? 1:2)]+ "</td>";
				str+="<td style='width:200px'>" +VirtualServerList[z][1] +"</td>";
				//str+="<td>" +sourceinf_dsl[v_inter]+ "</td>";
				str+="<td>" +VirtualServerList[z][2]+"<br>"+VirtualServerList[z][3]+"-"+VirtualServerList[z][4]+"</td>";
				str+="<td>" +VirtualServerList[z][5]+"-"+VirtualServerList[z][6]+"</td>";
 				str+="<td>" +VirtualServerList[z][7]+ "</td>";
				str+="<td>" +VirtualServerList[z][8]+ "</td>";
				str+='<td><img src="/graphic/New_GUI/edit_btn.gif" width=28 height=28 style="cursor:pointer" onclick="EditRow('+z+')"/></td>';
				str+='<td>';
				str+='<img src="/graphic/New_GUI/trash.gif" width=41 height=41 style="cursor:pointer" onclick="deleteDate('+z+')"/>';
				str+='<input type="hidden" id="enable'+z+'" name="enable'+z+'">';
				str+='</td>';
				str+="</tr>";
			}
		}		
	}	

	for (var i = 0; i < upnp_CommonNum; i++) {
		str += "<tr>";
		str += "<td align=center>" + macAction[1] + "</td>";
		str += "<td style='width:200px'>&nbsp;</td>";
		str += "<td>" + upnpRuleList[i][1] + "<br>" + upnpRuleList[i][2] + "</td>";
		str += "<td>" + upnpRuleList[i][0] + "</td>";
		str += "<td>" + upnpRuleList[i][3].toUpperCase() + "</td>";
		str += '<td>&nbsp;</td>';
		str += '<td>&nbsp;</td>';
		str += '<td>&nbsp;</td>';
		str += "</tr>";
	}

	document.write(str);		
}	
function EditRow(z) {

	createUserButton();
	
	$("#editRow").val(z);
	var lists = VirtualServerList;	
	
	if (lists[z][0]=="Yes")
		SetCheckBoxEnable("enable_vs_rules", true, true);
	else
		SetCheckBoxEnable("enable_vs_rules", true, false);
	hideSaveBtn();

	$("#name").val(decodeSpecialChr(lists[z][1]));
	$("#inIP").val(lists[z][2]);
	$("#insPort").val(lists[z][3]);
	$("#inePort").val(lists[z][4]);
	$("#exsPort").val(lists[z][5]);
	$("#exePort").val(lists[z][6]);
	
	$("#protocol").val(lists[z][7]);
	$('#protocol').selectbox('change', $("#protocol").val(), $("#protocol").find('option:selected').text());

	if(lists[z][8] == "-")
		$("#pf_Schedule").val("Always");
	else
		$("#pf_Schedule").val(lists[z][8]);
	$('#pf_Schedule').selectbox('change', $("#pf_Schedule").val(), $("#pf_Schedule").find('option:selected').text());

	hideSaveBtn();	
}

function uiDoOnLoad() {	
	//var f = document.getElementById("inter");	
	
	//getInterface();
	//$("#inter").val(nat_pvc);
	//$("#inter").selectbox();	

	/*if(f.options.length == 0){
		document.getElementById("createButton").setAttribute("class", "styled_button_dis");
		document.getElementById("createButton").disabled = true;
	}
	else{*/
		if(parseInt(Nempty) < parseInt(maxRule)){
			document.getElementById("createButton").setAttribute("class", "styled_button_s");
			document.getElementById("createButton").disabled = false;
		}
		else{
			document.getElementById("createButton").setAttribute("class", "styled_button_dis");
			document.getElementById("createButton").disabled = true;
		}		
	//}	

	var selectSchedule = document.getElementById("pf_Schedule");
	for(var i=0; i<maxScheduleRule; i++){
		if(ScheduleList[i] != "")
			selectSchedule.options.add(new Option(ScheduleList[i], ScheduleList[i]));
	}
	$("#pf_Schedule").selectbox();	
}

function deleteDate(i) {
	var f = document.getElementById("frm");
	var st = eval("f.enable"+i);	
	st.value = 1;
	
	if(confirm(m_comm_deldesc)) {
		$("#buttonType").val("delete");

		document.getElementById("CreatePopAlertMessage").style.display = "inline";
		document.getElementById("waitSettingFinish").style.display = "inline";
		Start_reciprocal_Number_RestoreConfiguration();
		
		$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey){
			$("#sessionKey").val(sessionKey);	
			setTimeout('$.post("/cgi-bin/New_GUI/VirtualServer.asp", $("form").serialize(), function(){save_flag = true;});', 300);
		});
	}
}

function isNumber(n) {
	if (n.length==0) return false;
	for (var i=0;i < n.length;i++) {
		if (n.charAt(i) < '0' || n.charAt(i) > '9') return false;
	}
	return true;
}

function isLanip(value) {
	var lanip, lanip_all;
	var dmzip = MathandAbs($("#inIP").val()).split(".");
	var error=0;

	for(var i=0; i<2;i++) {
		lanip_all = eval("lan"+i);
		if(lanip_all == "N/A")
			continue;
		lanip = lanip_all.split(".");
		if((lanip[0] != dmzip[0])||(lanip[1] != dmzip[1])||(lanip[2] != dmzip[2])||evalIP($("#inIP").val())==lanip_all)
			error++;
	}

	if(error == 2)
		return false;
	else
		return true;
}

function evalIP(ip) {
	var sIP=MathandAbs(ip).split(".");

	for(var i=0; i< sIP.length; i++)
		sIP[i]=parseInt(sIP[i],10);
 	dIP = sIP[0]+"."+sIP[1]+"."+sIP[2]+"."+sIP[3];
	return dIP;	
}

function MathandAbs(ip) {
	var sIP=ip.split(".");
	absip = Math.abs(sIP[0])+"."+Math.abs(sIP[1])+"."+Math.abs(sIP[2])+"."+Math.abs(sIP[3]); 
	return absip;
}
 
function Prefixes_Rule(TelNum) {
	for (var i=0; i<TelNum.length; i++) {     
		if(TelNum.charAt(i)=='#') return false;
		if(TelNum.charAt(i)=='&') return false;
	}
	return true;
}
 function checkSameRule(editFlag) {
	var f=document.getElementById("frm");
	
	var lists = VirtualServerList;

	for(var z = 0; z < lists.length; z++) {
		if(parseInt(editFlag) == parseInt(z))
			continue;

		if(lists[z][2]=="")
			continue;

		var sameId = 0;
		var check_lists = lists[z];

		if(f.inIP.value.toString() == check_lists[2].toString())
			sameId++;

		if(f.insPort.value.toString() == check_lists[3].toString())
			sameId++;

		if(f.inePort.value.toString() == check_lists[4].toString())
			sameId++;

		if(f.exsPort.value.toString() == check_lists[5].toString())
			sameId++;

		if(f.exePort.value.toString() == check_lists[6].toString())
			sameId++;

		if(f.protocol.value.toString() == check_lists[7].toString())
			sameId++;

		/*if(f.pf_Schedule.value.toString() == check_lists[8].toString())
			sameId++;*/
		
		if(sameId >= 6)
			return false;
	}
	return true;
}

function uiDoValidate() {
	var entry;
	if($("#editRow").val()=="-1")
		entry=-1;
	else
		entry=parseInt($("#editRow").val());
	
	if (($("#name").val()=="")||($("#name").val().length>32)||(!Prefixes_Rule_cgi_num($("#name").val())) || ($("#name").val() == "-")) {
		$("#name_error").html("<br/>"+m_virser_error1);
		return false;
	}

	for(var z = 0; z < VirtualServerList.length; z++) {
		if(parseInt(entry) == parseInt(z))
			continue;

		var check_lists = VirtualServerList[z];	
		if($("#name").val() == check_lists[1].toString()){	
			$("#name_error").html("<br/>"+m_virser_error2);
			return false;
		}
	}
	if ((!is_valid_ip($("#inIP").val(),0))||(!isLanip($("#inIP").val()))) {
		$("#inIP_error").html("<br/>"+m_virser_error3);
		return false;
	}

	if (!isNumber($("#insPort").val())||parseInt($("#insPort").val())<1||parseInt($("#insPort").val())>65535) {
		$("#insPort_error").html("<br/>"+m_virser_error4);
		return false;
	}

	if (!isNumber($("#inePort").val())||parseInt($("#inePort").val())<1||parseInt($("#inePort").val())>65535 ) {
		$("#inePort_error").html("<br/>"+m_virser_error4);
		return false;
	}

	if((parseInt($("#insPort").val())>parseInt($("#inePort").val()))) {	
		$("#insPort_error").html("<br/>"+m_virser_error5);
		return false;
	}

	if (!isNumber($("#exsPort").val())||parseInt($("#exsPort").val())<1||parseInt($("#exsPort").val())>65535 ) {
		$("#exsPort_error").html("<br/>"+m_virser_error4);
		return false;
	}

	if (!isNumber($("#exePort").val())||parseInt($("#exePort").val())<1||parseInt($("#exePort").val())>65535 ) {
		$("#exePort_error").html("<br/>"+m_virser_error4);
		return false;
	}
	
	if((parseInt($("#exsPort").val())>parseInt($("#exePort").val()))) {		
		$("#exsPort_error").html("<br/>"+m_virser_error6);
		return false;
	}	
	if(!checkSameRule(entry)) {
		alert(m_comm_ruleused);			
		return false;
	}
	
	return true;
}

function uiDoSave() {	
	$("label[class='error']").html("");	

	if(uiDoValidate()==false){
		return;
	}
	
	if($("#editRow").val() == -1) {
		for(var i = 0; i < VirtualServerList.length; i++) {
			if(VirtualServerList[i][1] == "") {
				$("#editRow").val(i);
				break;
			}
		}	
	}

	if($("#enable_vs_rules_ck").attr("checked"))
		$("#enable_rules").val("Yes");
	else
		$("#enable_rules").val("No");
	
	if(parseInt(ACL_All_Active) == 1) {
		var insPort = parseInt($("#insPort").val());
		var inePort = parseInt($("#inePort").val());
		var exsPort = parseInt($("#exsPort").val());
		var exePort = parseInt($("#exePort").val());

		var flag = false;

		if(insPort <= 80 && inePort >= 80)
			flag = true;
		if(exsPort <= 80 && exePort >= 80)
			flag = true;

		if(flag)
			alert(m_acl_waring);
	}

	if($("#pf_Schedule").val() == "Always")
		$("#scheduleValue").val('-');
	else
		$("#scheduleValue").val($("#pf_Schedule").val());

	$("#buttonType").val("apply");

	document.getElementById("CreatePopAlertMessage").style.display = "inline";
	document.getElementById("waitSettingFinish").style.display = "inline";
	Start_reciprocal_Number_RestoreConfiguration();
	
	$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey){
		$("#sessionKey").val(sessionKey);	
		setTimeout('$.post("/cgi-bin/New_GUI/VirtualServer.asp", $("form").serialize(), function(){save_flag = true;});', 300);
	});	
}

function createUserButton() {
	var showPop = false;
	var inter_comm = 0;
	if(TransMode == "PTM") {
		for (var j = 0; j < ruleListNo.length; j++) {
			var i = ruleListNo[j];
			if (wan8_pvc_active[i] == "Yes" && wan8_pvc_enable[i] == "Enable") {
				showPop = true;
				break;
			}
		}
	} else {
		showPop = true;
	}

	if(showPop) {
		$("#popTitle").html(m_comm_createnew);
		document.getElementById("createPop").style.display = "inline";
		document.getElementById("createButton").disabled = true;
		$("#frm").val(-1);
		initPop();
	} else {
		document.getElementById("CreatePopAlertMessage").style.display = "inline";
		document.getElementById("showPopError").style.display = "inline";
	}
}

function initPop(){
	$("#editRow").val("-1");
	
	//getInterface();
	//getInterfaceEdit();

	if(TransMode == "ATM")
		$("#inner_display").val("0");
	else if(TransMode == "PTM")
		$("#inner_display").val("8");
	
	//$("#inner_display").selectbox();
	//$('#inner_display').selectbox('change', $("#inner_display").val(), $("#inner_display").find('option:selected').text());
	//$("#inner_display").selectbox("disable");

	InitInterface();
	if(parseInt($("#inner_display").val())==8 || parseInt($("#inner_display").val())==10){
		$("#service").val(nat_pvc_ext);
		$("#service").selectbox();
		$('#service').selectbox('change', $("#service").val(), $("#service").find('option:selected').text());
	}
	
	$("input[type='text']").val('');
	
	$("#protocol").val('ALL');
	$("#protocol").selectbox();
	$('#protocol').selectbox('change', $("#protocol").val(), $("#protocol").find('option:selected').text());
	
	$("#pf_Schedule").val('Always');
	$('#pf_Schedule').selectbox('change', $("#pf_Schedule").val(), $("#pf_Schedule").find('option:selected').text());

	SetCheckBoxEnable("enable_vs_rules", true, true);

	hideSaveBtn();
}

function resetRulePOP()
{	
	//$("#inner_display").selectbox("enable");	
	document.getElementById("createPop").style.display = "none";
}


function check_TotalRule(maxRule, totalRule)
{		
	var IsFull = maxRule - totalRule;		
	document.getElementById("RemainingRules").innerHTML = IsFull;
	
	if (IsFull == 0)
	{
		document.getElementById("createButton").setAttribute("class", "styled_button_dis");
		document.getElementById("createButton").disabled = true;
	}
	else
	{
		document.getElementById("createButton").setAttribute("class", "styled_button_s");
		document.getElementById("createButton").disabled = false;
	}
}


function clearCreateRulePOP()
{
	resetRulePOP();
	$("input[type='text']").val("");
	$("label[class='error']").html("");
	$(':text').prop('className', 'styled-text');	
	check_TotalRule(maxRule, Nempty);
	document.getElementById("createButton").setAttribute("class", "styled_button_s");
	document.getElementById("createButton").disabled = false;
}

function closeErrorPop(){
	document.getElementById("CreatePopAlertMessage").style.display = "none";
	document.getElementById("showPopError").style.display = "none";
}

function changeVirtualServer(){
	SetCheckBoxEnable("enable_vs_rules");
	hideSaveBtn();
}

var save_flag = false;
var _ReciprocalNumber = 10;
function Start_reciprocal_Number_RestoreConfiguration() {
	if (_ReciprocalNumber >= 0) {
		document.getElementById("reciprocal_Number").innerHTML = _ReciprocalNumber + m_comm_Sec;
		_ReciprocalNumber --;
		setTimeout("Start_reciprocal_Number_RestoreConfiguration()", 1000);
	} else {
		if(save_flag) {
			document.getElementById("waitSettingFinish").style.display = "none";
			document.getElementById("SuccessSettings").style.display = "inline";
		} else {
			setTimeout("Start_reciprocal_Number_RestoreConfiguration()", 1000);
		}
	}
}

