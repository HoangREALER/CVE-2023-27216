var maxRule = 16;
var parentalControlCount = 0;
var parentalControlList = new Array();
CountParentalControl();

function CountParentalControl() {
	for (var i = 0; i < maxRule; i++) {
		var urlfilter_name = eval("urlfilter" + i + "_name");
		if (urlfilter_name != "N/A") {
			var urlfilter_url = eval("urlfilter" + i + "_url");
			var urlfilter_sch = eval("urlfilter" + i + "_schedule");
			parentalControlList.push([urlfilter_name, urlfilter_url, urlfilter_sch]);
			parentalControlCount++;
		} else {
			parentalControlList.push(["", "", ""]);
		}
	}
}

var maxScheduleRule = 10;
var ScheduleCount = 0;
var ScheduleList = new Array();
CountSchedule();

function CountSchedule() {
	for (var i = 0; i < maxScheduleRule; i++) {
		var port_name = eval("port" + i + "_name");
		if (port_name != "N/A") {
			ScheduleList.push(port_name);
			ScheduleCount++;
		} else {
			ScheduleList.push("");
		}
	}
}

function uiDoOnLoad() {
	var f = document.getElementById("frm");

	$("#url_enable").val(urlfilter_mode);
	$("#url_enable").selectbox({
		width: 600
	});

	if (f.url_enable.options[0].selected) {
		$("#createButton").removeClass();
		$("#createButton").addClass("styled_button_dis");
		$("#createButton").attr("disabled", "disabled");
	} else {
		$("#createButton").removeClass();
		$("#createButton").addClass("styled_button_s");
		$("#createButton").removeAttr("disabled");
	}

	if (parseInt(parentalControlCount) < parseInt(maxRule)) {
		if (f.url_enable.options[0].selected) {
			$("#createButton").removeClass();
			$("#createButton").addClass("styled_button_dis");
			$("#createButton").attr("disabled", "disabled");
		} else {
			$("#createButton").removeClass();
			$("#createButton").addClass("styled_button_s");
			$("#createButton").removeAttr("disabled");
		}
	} else {
		$("#createButton").removeClass();
		$("#createButton").addClass("styled_button_dis");
		$("#createButton").attr("disabled", "disabled");
	}

	$("#url_enable").change(function() {
		var urlEnable = "disable";
		if (f.url_enable.options[0].selected)
			urlEnable = "disable";
		else if (f.url_enable.options[1].selected)
			urlEnable = "white";
		else if (f.url_enable.options[2].selected)
			urlEnable = "black";

		$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey) {
			setTimeout('$.post("/cgi-bin/New_GUI/Set/ParentalControl.asp", { sessionKey: "' + sessionKey + '", urlEnable: "' + urlEnable + '" }, function(){self.location.href = self.location.href;});', 300);
		});
	});

	var selectSchedule = document.getElementById("pf_Schedule");
	for (var i = 0; i < maxScheduleRule; i++) {
		if (ScheduleList[i] != "")
			selectSchedule.options.add(new Option(ScheduleList[i], ScheduleList[i]));
	}
	$("#pf_Schedule").selectbox();
}
function deleteDate(i) {
	var f = document.getElementById("frm");
	var st = eval("f.enable_" + i);
	st.value = 1;

	if (confirm(m_comm_deldesc)) {
		var delCount = 1;
		f.ParentalControlNum.value = parentalControlCount - delCount;
		f.buttonType.value = "delete";

		document.getElementById("CreatePopAlertMessage").style.display = "inline";
		document.getElementById("waitSettingFinish").style.display = "inline";
		Start_reciprocal_Number_RestoreConfiguration();

		$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey) {
			$("#sessionKey").val(sessionKey);
			setTimeout('$.post("/cgi-bin/New_GUI/ParentalControl.asp", $("form").serialize(), function(){save_flag = true;});', 300);
		});
	}
}

function EditRow(r) {
	createEditButton();

	var f = document.getElementById("frm");
	f.editRow.value = r;

	var urlfilter_name = eval("urlfilter" + r + "_name");
	var urlfilter_url = eval("urlfilter" + r + "_url");
	var urlfilter_sch = eval("urlfilter" + r + "_schedule");

	$("#url_name").val(decodeSpecialChr(urlfilter_name));
	$("#url_keyword").val(decodeSpecialChr(urlfilter_url));
	if (urlfilter_sch == "-")
		$("#pf_Schedule").val("Always");
	else
		$("#pf_Schedule").val(urlfilter_sch);
	$('#pf_Schedule').selectbox('change', $("#pf_Schedule").val(), $("#pf_Schedule").find('option:selected').text());
}

function gen_url_list() {
	var str = "";
	if (parentalControlCount > 0) {
		for (var i = 0; i < parentalControlList.length; i++) {
			if (parentalControlList[i][0] != "") {
				str += "<tr>";
				str += "<td align=center>" + parentalControlList[i][0] + "</td>";
				str += "<td align=center>" + parentalControlList[i][1] + "</td>";
				str += "<td align=center>" + parentalControlList[i][2] + "</td>";
				str += '<td><img src="/graphic/New_GUI/edit_btn.gif" width=28 height=28 style="cursor:pointer" onclick="EditRow(' + i + ')"/></td>';
				str += '<td>';
				str += '<img src="/graphic/New_GUI/trash.gif" width=41 height=41 style="cursor:pointer" onclick="deleteDate(' + i + ')"/>';
				str += '<input type="hidden" id="enable_' + i + '" name="enable_' + i + '">';
				str += '</td>';
				str += "</tr>";
			}
		}
	}
	document.write(str);
}

function Prefixes_Rule(TelNum) {
	if (TelNum.length < 1) return false;
	for (var i = 0; i < TelNum.length; i++) {
		if ((TelNum.charAt(i) == " ") || (TelNum.charAt(i) == '\"') || (TelNum.charAt(i) == '-'))
			return false;
	}
	return true;
}

function isValidAscii(val) {
	for (var i = 0; i < val.length; i++) {
		var ch = val.charAt(i);
		if (ch < ' ' || ch > '~')
			return ch;
	}
	return '';
}

function isValidUrlName(url) {
	var i = 0;
	var invalidArray = new Array();
	invalidArray[i++] = "www";
	invalidArray[i++] = "com";
	invalidArray[i++] = "org";
	invalidArray[i++] = "net";
	invalidArray[i++] = "edu";
	invalidArray[i++] = "www.";
	invalidArray[i++] = ".com";
	invalidArray[i++] = ".org";
	invalidArray[i++] = ".net";
	invalidArray[i++] = ".edu";

	if (isValidAscii(url) != '')
		return false;

	for (i = 0; i < url.length; i++) {
		if (url.charAt(i) == '\\' || url.charAt(i) == ' ' || url.charAt(i) == '#' || url.charAt(i) == '@' || url.charAt(i) == ',' || url.charAt(i) == '%')
			return false;
	}

	if (url == "")
		return false;

	if (url.length < 3)
		return false;

	for (j = 0; j < invalidArray.length; j++) {
		if (url == invalidArray[j])
			return false;
	}
	return true;
}

function invalidChar(value) {
	for (var i = 0; i < value.length; i++) {
		if ((value.charAt(i) == ' ') || (value.charAt(i) == '\\'))
			return false;
	}
	return true;
}

function uiDoValidate_url() {
	var f = document.getElementById("frm");

	if (!f.url_enable.options[0].selected) {

		if (f.url_name.value == "" || f.url_name.value.length == 0) {
			$("#url_name_error").html("<br/>" + m_website_name_error1);
			$("#url_name").focus();
			$("#url_name").select();
			return false;
		}
		if (f.url_name.value.length > 16) {
			$("#url_name_error").html("<br/>" + m_website_name_error2);
			$("#url_name").focus();
			$("#url_name").select();
			return false;
		}
		if (!Prefixes_Rule_cgi_num(f.url_name.value)) {
			$("#url_name_error").html("<br/>" + m_website_name_error3);
			$("#url_name").focus();
			$("#url_name").select();
			return false;
		}

		for (var i = 0; i < parentalControlList.length; i++) {
			if (i == parseInt(f.editRow.value))
				continue;
			else {
				if (f.url_name.value == parentalControlList[i][0]) {
					$("#url_name_error").html("<br/>" + m_website_name_error4);
					$("#url_name").focus();
					$("#url_name").select();
					return false;
				}
			}
		}

		if (f.url_keyword.value == "" || f.url_keyword.value.length == 0) {
			$("#url_keyword_error").html("<br/>" + m_website_url_error1);
			$("#url_keyword").focus();
			$("#url_keyword").select();
			return false;
		}
		if (f.url_keyword.value.length > 64) {
			$("#url_keyword_error").html("<br/>" + m_website_url_error2);
			$("#url_keyword").focus();
			$("#url_keyword").select();
			return false;
		}
		if (!invalidChar(f.url_keyword.value)) {
			$("#url_keyword_error").html("<br/>" + m_website_url_error3);
			$("#url_keyword").focus();
			$("#url_keyword").select();
			return false;
		}
	}

	return true;
}

function uiDoSave_url() {
	$("label[class='error']").html("");
	var f = document.getElementById("frm");

	if (!uiDoValidate_url())
		return;

	if (f.editRow.value == -1) {
		for (var i = 0; i < parentalControlList.length; i++) {
			if (parentalControlList[i][0] == "") {
				f.editRow.value = i;
				break;
			}
		}
		f.ParentalControlNum.value = parentalControlCount + 1;
	} else {
		f.ParentalControlNum.value = parentalControlCount;
	}

	f.keywords.value = subHML(f.url_keyword.value);
	if ($("#pf_Schedule").val() == "Always")
		$("#scheduleValue").val('-');
	else
		$("#scheduleValue").val($("#pf_Schedule").val());
	f.buttonType.value = "apply";

	document.getElementById("CreatePopAlertMessage").style.display = "inline";
	document.getElementById("waitSettingFinish").style.display = "inline";
	Start_reciprocal_Number_RestoreConfiguration();

	$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey) {
		$("#sessionKey").val(sessionKey);
		setTimeout('$.post("/cgi-bin/New_GUI/ParentalControl.asp", $("form").serialize(), function(){save_flag = true;});', 300);
	});
}

function subHML_2(item) {
	var str;
	str = item.replace(/&#39/ig, "'");
	return str;
}

function createEditButton() {
	$("#popTitle").html(m_comm_createnew);
	document.getElementById("createPop").style.display = "inline";
	document.getElementById("createButton").disabled = true;
	$("#frm").val(-1);
}

function createUserButton() {
	$("#popTitle").html(m_comm_createnew);
	document.getElementById("createPop").style.display = "inline";
	document.getElementById("createButton").disabled = true;
	$("#frm").val(-1);

	initPop();
}

function initPop() {
	var f = document.getElementById("frm");
	$("select option:first").attr("selected", true);
	$("input[type='text']").val('');
	$("#editRow").val('-1');

	hideSaveBtn();
}

function resetRulePOP() {
	document.getElementById("createPop").style.display = "none";
}

function check_TotalRule(maxRule, totalRule) {
	var IsFull = maxRule - totalRule;
	document.getElementById("RemainingRules").innerHTML = IsFull;

	if (IsFull == 0) {
		document.getElementById("createButton").setAttribute("class", "styled_button_dis");
		document.getElementById("createButton").disabled = true;
	} else {
		document.getElementById("createButton").setAttribute("class", "styled_button_s");
		document.getElementById("createButton").disabled = false;
	}
}

function clearCreateRulePOP() {
	resetRulePOP();
	$("label[class='error']").html("");
	$("select option:first").attr("selected", true);
	$(':text').prop('className', 'styled-text');
	check_TotalRule(maxRule, parentalControlCount);
}

var save_flag = false;
var _ReciprocalNumber = 10;

function Start_reciprocal_Number_RestoreConfiguration() {
	if (_ReciprocalNumber >= 0) {
		document.getElementById("reciprocal_Number").innerHTML = _ReciprocalNumber + " " + m_comm_Sec;
		_ReciprocalNumber--;
		setTimeout("Start_reciprocal_Number_RestoreConfiguration()", 1000);
	} else {
		if (save_flag) {
			document.getElementById("waitSettingFinish").style.display = "none";
			document.getElementById("SuccessSettings").style.display = "inline";
		} else {
			setTimeout("Start_reciprocal_Number_RestoreConfiguration()", 1000);
		}
	}
}

function subHML(item) {
	var str;
	str = item.replace(/'/ig, "&#39");
	return str;
}