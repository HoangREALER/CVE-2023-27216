var maxRule = 32;
var macFDataListsCount = 0;
var MacFilterList = new Array();
var weekList = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
CountMacFilter();
function CountMacFilter() {
	for(var i = 0; i < maxRule; i++) {
		var macFilter_name = eval("macFilter"+i+"_name");
		if(macFilter_name != "N/A") {
			var macFilter_mac = eval("macFilter"+i+"_mac");			
			MacFilterList.push([macFilter_name,macFilter_mac]);
			macFDataListsCount ++;
		} else {
			MacFilterList.push(["",""]);
		}
	}
}

var maxScheduleRule = 10;
var ScheduleCount = 0;
var ScheduleList = new Array();	
CountSchedule();
function CountSchedule() {
	for(var i = 0; i < maxScheduleRule; i++) {
		var port_name = eval("port"+i+"_name");
		if(port_name != "N/A") {				
			ScheduleList.push(port_name);
			ScheduleCount ++;
		} 
		else {
			ScheduleList.push("");
		}
	}
}

function uiDoOnLoad() {
	var f=document.getElementById("frm");	

	if(parseInt(macFDataListsCount) < parseInt(maxRule)){
		document.getElementById("createButton").setAttribute("class", "styled_button_s");
		document.getElementById("createButton").disabled = false;
	}
	else{
		document.getElementById("createButton").setAttribute("class", "styled_button_dis");
		document.getElementById("createButton").disabled = true;
	}

	$("#filter_enable").val(macFilter_enable);
	$("#filter_enable").selectbox({width:600});
	$('#filter_enable').selectbox('change', $("#filter_enable").val(), $("#filter_enable").find('option:selected').text());

	if(f.filter_enable.options[0].selected) {
		$("#createButton").removeClass();
		$("#createButton").addClass("styled_button_dis");
		$("#createButton").attr("disabled", "disabled");
	} else {
		$("#createButton").removeClass();
		$("#createButton").addClass("styled_button_s");
		$("#createButton").removeAttr("disabled");
	}

	$("#filter_enable").change(function() {
		var filter_enable = "disable";
		
		if(f.filter_enable.options[0].selected)
			filter_enable = "disable";
		else if(f.filter_enable.options[1].selected)
			filter_enable = "white";
		else if(f.filter_enable.options[2].selected)
			filter_enable = "black";

		$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey){
			setTimeout('$.post("/cgi-bin/New_GUI/Set/MacFilter.asp", { sessionKey: "'+sessionKey+'", filter_enable: "'+filter_enable+'" }, function(){self.location.href = self.location.href;});', 300);
		});		
	});

	var selectSchedule = document.getElementById("pf_Schedule");
	for(var i=0; i<maxScheduleRule; i++){
		if(ScheduleList[i] != "")
			selectSchedule.options.add(new Option(ScheduleList[i], ScheduleList[i]));
	}
	$("#pf_Schedule").selectbox();	
}

function gen_table() {
	var str="";
	if(macFDataListsCount!=0) {
		for(var i = 0; i < maxRule; i++) {
			var macFilter_name = eval("macFilter"+i+"_name");
			if(macFilter_name != "N/A") {
				var macFilter_mac = eval("macFilter"+i+"_mac");
				str+="<tr>";
				str+="<td style='width:300px'>" +macFilter_name +"</td>";
				str+="<td>" +macFilter_mac +"</td>";
				var mac_schedule = eval("macFilter"+i+"_schedule");
				mac_schedule = (mac_schedule == "N/A" ? "-" : mac_schedule);
				str += "<td>" + mac_schedule + "</td>";
				str+='<td><img src="/graphic/New_GUI/edit_btn.gif" width=28 height=28 style="cursor:pointer" onclick="EditRow('+i+')"/></td>';
				str+='<td>';
				str+='<img src="/graphic/New_GUI/trash.gif" width=41 height=41 style="cursor:pointer" onclick="deleteDate('+i+')"/>';
				str+='<input type="hidden" id="enable_'+i+'" name="enable_'+i+'">';
				str+='</td>';
				str+="</tr>";
			}
		}					
 	}
	 document.write(str);
}

function deleteDate(i) {
	var f = document.getElementById("frm");
	var st = eval("f.enable_"+i);	
	st.value = 1;

	if(confirm(m_comm_deldesc)) {
		var delCount = 1;	
		f.macfilter_num.value = macFDataListsCount - delCount;
		f.button_type.value = "delete";

		document.getElementById("CreatePopAlertMessage").style.display = "inline";
		document.getElementById("waitSettingFinish").style.display = "inline";
		Start_reciprocal_Number_RestoreConfiguration();
		
		$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey){
			$("#sessionKey").val(sessionKey);	
			setTimeout('$.post("/cgi-bin/New_GUI/MacFilter.asp", $("form").serialize(), function(){save_flag = true;});', 300);
		});
	}	
}

function EditRow(r) {

	createEditButton();
	
	var f = document.getElementById("frm");
	var macFilter_name = eval("macFilter"+r+"_name");
	var macFilter_mac = eval("macFilter"+r+"_mac");
	
	f.editRow.value=r;

	$("#name").val(decodeSpecialChr(macFilter_name));
	
	var myMac = macFilter_mac.split(":");
	$("#mac0").val(myMac[0]);
	$("#mac1").val(myMac[1]);
	$("#mac2").val(myMac[2]);
	$("#mac3").val(myMac[3]);
	$("#mac4").val(myMac[4]);
	$("#mac5").val(myMac[5]);

	var macFilter_schedule = eval("macFilter"+r+"_schedule");

	if(macFilter_schedule == "-" || macFilter_schedule == "" ||macFilter_schedule == "N/A")
		$("#pf_Schedule").val("Always");
	else
		$("#pf_Schedule").val(macFilter_schedule);
	$('#pf_Schedule').selectbox('change', $("#pf_Schedule").val(), $("#pf_Schedule").find('option:selected').text());	
}



function checkMAC(m) {
	var allowChar="01234567890ABCEDF";
	if(m==null) return false;
	if(m.length!=2) return false;
	m=m.toUpperCase();
	for (var i=0; i < m.length; i++) {
		if (allowChar.indexOf(m.charAt(i)) == -1) return false;
	}
	if (m.length==0) return false;
	return true;
}

function checkUsedRule(id) {
	var f = document.getElementById("frm");
	var flag = 0;
	var myMac=f.mac0.value+":"+f.mac1.value+":"+f.mac2.value+":"+f.mac3.value+":"+f.mac4.value+":"+f.mac5.value;

	for(var i = 0; i < MacFilterList.length; i++) {
		if(id == i)
			continue;
		if(myMac == MacFilterList[i][1])
			flag++;
		else if(f.name.value == MacFilterList[i][0])
			flag++;
	}
	if(flag != 0)
		return false;
	return true;
}

function uiDoValidate() {
	var f = document.getElementById("frm");

	if(f.filter_enable.options[0].selected)
		return true;
	
	var entry;
	if(f.editRow.value=="-1")
		entry=-1;
	else
		entry=parseInt(f.editRow.value);
	
	if(f.name.value != "") {
		if (f.name.value.length>32)
		{
			$("#name_error").html("<br/>"+m_ipfilter_error1);
			return false;
		}
		if(!isUnsafeChar(f.name.value)) {
			$("#name_error").html("<br/>"+m_ipfilter_error2);
			return false;
		}
		if (!f.filter_enable[0].checked) {	
			if (f.name.value.length==0) {
				$("#name_error").html("<br/>"+m_macfilter_error1);
				return false;
			} 
			else if(f.name.value.indexOf("-") != -1){
				$("#name_error").html("<br/>"+m_macfilter_error1);
				return false;
			}
			
			if(f.mac0.value.toString() == "01") {
				$("#mac_error").html("<br/>"+m_macfilter_error2);
				return false;    
			}
			
			var myMac=f.mac0.value+":"+f.mac1.value+":"+f.mac2.value+":"+f.mac3.value+":"+f.mac4.value+":"+f.mac5.value;
			var m=myMac;
			
			if(m.length > 5) {
		 		if (m.search(":") != -1)    
					var tmp=m.split(":");
				else    	
					var tmp=m.split("-");

				if (!(checkMAC(tmp[0])&&checkMAC(tmp[1])&&checkMAC(tmp[2])&&checkMAC(tmp[3])&&checkMAC(tmp[4])&&checkMAC(tmp[5]))) {
					$("#mac_error").html("<br/>"+m_macfilter_error2);
					return false;    
				}
			} 
			else {
				$("#mac_error").html("<br/>"+m_macfilter_error3);
				return false;
			}
			if(m=="00:00:00:00:00:00"||m.toLowerCase()=="ff:ff:ff:ff:ff:ff")
			{
				$("#mac_error").html("<br/>"+m_macfilter_error2);
				return false;
			}
	
			if(!checkUsedRule(entry)) {
				alert(m_comm_ruleused);
				return false;
			}	
		}	
	}	
	return true;
}

function uiDoSave() {
	$("label[class='error']").html("");
	var f = document.getElementById("frm");

	if(f.filter_enable.options[0].selected)
		f.filter_enables.value = "disable";
	else if(f.filter_enable.options[1].selected)
		f.filter_enables.value = "white";
	else if(f.filter_enable.options[2].selected)
		f.filter_enables.value = "black";
	else
		f.filter_enables.value = "disable";
	
	if(!uiDoValidate()){
		return;
	}
	if(f.editRow.value=="-1") {
		for(var i = 0; i < MacFilterList.length; i++) {
			if(MacFilterList[i][0] == "") {
				f.editRow.value = i;
				break;
			}
		}
		f.macfilter_num.value = (macFDataListsCount+1);
	} else {
		f.macfilter_num.value = macFDataListsCount;
	}
	f.macAddr.value = f.mac0.value+":"+f.mac1.value+":"+f.mac2.value+":"+f.mac3.value+":"+f.mac4.value+":"+f.mac5.value;	

	if($("#pf_Schedule").val() == "Always")
		$("#scheduleValue").val('-');
	else
		$("#scheduleValue").val($("#pf_Schedule").val());
	
	f.button_type.value = "apply";

	document.getElementById("CreatePopAlertMessage").style.display = "inline";
	document.getElementById("waitSettingFinish").style.display = "inline";
	Start_reciprocal_Number_RestoreConfiguration();
	
	$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey){
		$("#sessionKey").val(sessionKey);	
		setTimeout('$.post("/cgi-bin/New_GUI/MacFilter.asp", $("form").serialize(), function(){save_flag = true;});', 300);
	});
}



function createEditButton()
{
	$("#popTitle").html(m_comm_createnew);
	document.getElementById("createPop").style.display = "inline";
	document.getElementById("createButton").disabled = true;
	$("#frm").val(-1);
}

function createUserButton()
{
	$("#popTitle").html(m_comm_createnew);
	document.getElementById("createPop").style.display = "inline";
	document.getElementById("createButton").disabled = true;
	$("#frm").val(-1);

	initPop();	
}

function initPop(){
	var f = document.getElementById("frm");
	$("input[type='text']").val('');	
	$("#editRow").val("-1");

	$("#mac0").val("00");
	$("#mac1").val("00");
	$("#mac2").val("00");
	$("#mac3").val("00");
	$("#mac4").val("00");
	$("#mac5").val("00");	

	$("#pf_Schedule").val('0');
	$('#pf_Schedule').selectbox('change', $("#pf_Schedule").val(), $("#pf_Schedule").find('option:selected').text());

	hideSaveBtn();	
}

function resetRulePOP()
{
	document.getElementById("createPop").style.display = "none";
}

function check_TotalRule(maxRule, totalRule)
{
	var IsFull = maxRule - totalRule;
	document.getElementById("RemainingRules").innerHTML = IsFull;
	
	if (IsFull == 0)
	{
		document.getElementById("createButton").setAttribute("class", "styled_button_dis");
		document.getElementById("createButton").disabled = true;
	}
	else
	{
		document.getElementById("createButton").setAttribute("class", "styled_button_s");
		document.getElementById("createButton").disabled = false;
	}
}

function clearCreateRulePOP()
{
	resetRulePOP();
	$("input[type='text']").val("");
	$("label[class='error']").html("");
	check_TotalRule(maxRule, macFDataListsCount);
}

var save_flag = false;
var _ReciprocalNumber = 10;
function Start_reciprocal_Number_RestoreConfiguration() {
	if (_ReciprocalNumber >= 0) {
		document.getElementById("reciprocal_Number").innerHTML = _ReciprocalNumber + m_comm_Sec;
		_ReciprocalNumber --;
		setTimeout("Start_reciprocal_Number_RestoreConfiguration()", 1000);
	} else {
		if(save_flag) {
			document.getElementById("waitSettingFinish").style.display = "none";
			document.getElementById("SuccessSettings").style.display = "inline";
		} else {
			setTimeout("Start_reciprocal_Number_RestoreConfiguration()", 1000);
		}
	}
}