var max_length = 8;
var interface_list = new Array();
var wan8_service_list = new Array();
var wan0_service_list = new Array();
var Nempty = 0;

var pvc_enable = new Array();
for(var i = 0; i < max_length; i++) {
	var pvc_en = eval("PVC"+i+"_Enable");
	if(pvc_en != "N/A") 
		pvc_enable.push(pvc_en);
	else
		pvc_enable.push("");
}

var pvc_active = new Array();
for(var i = 0; i < max_length; i++) {
	var pvc_ac = eval("PVC"+i+"_active");
	if(pvc_ac != "N/A") 
		pvc_active.push(pvc_ac);
	else
		pvc_active.push("");
}

var wan8_pvc_enable = new Array();
for(var i = 0; i < max_length; i++) {
	var pvc_en = eval("WAN8_PVC"+i+"_Enable");
	if(pvc_en != "N/A") 
		wan8_pvc_enable.push(pvc_en);
	else
		wan8_pvc_enable.push("");
}

var wan8_pvc_active = new Array();
for(var i = 0; i < max_length; i++) {
	var pvc_ac = eval("WAN8_PVC"+i+"_active");
	if(pvc_ac != "N/A") 
		wan8_pvc_active.push(pvc_ac);
	else
		wan8_pvc_active.push("");
}

var wan0_pvc_enable = new Array();
for(var i = 0; i < max_length; i++) {
	var pvc_en = eval("WAN0_PVC"+i+"_Enable");
	if(pvc_en != "N/A") 
		wan0_pvc_enable.push(pvc_en);
	else
		wan0_pvc_enable.push("");
}

var wan0_pvc_active = new Array();
for(var i = 0; i < max_length; i++) {
	var pvc_ac = eval("WAN0_PVC"+i+"_active");
	if(pvc_ac != "N/A") 
		wan0_pvc_active.push(pvc_ac);
	else
		wan0_pvc_active.push("");
}

var maxScheduleRule = 10;
var ScheduleCount = 0;
var ScheduleList = new Array();	
CountSchedule();
function CountSchedule() {
	for(var i = 0; i < maxScheduleRule; i++) {
		var port_name = eval("port"+i+"_name");
		if(port_name != "N/A") {				
			ScheduleList.push(port_name);
			ScheduleCount ++;
		} 
		else {
			ScheduleList.push("");
		}
	}
}

function initDMZ() {		
	if(parseInt(Nempty) < parseInt(max_length)){
		document.getElementById("createButton").setAttribute("class", "styled_button_s");
		document.getElementById("createButton").disabled = false;
	}
	else{
		document.getElementById("createButton").setAttribute("class", "styled_button_dis");
		document.getElementById("createButton").disabled = true;
	}		

	/*var selectSchedule = document.getElementById("pf_Schedule");
	for(var i=0; i<maxScheduleRule; i++){
		if(ScheduleList[i] != "")
			selectSchedule.options.add(new Option(ScheduleList[i], ScheduleList[i]));
	}
	$("#pf_Schedule").selectbox();*/

	getInterface();
}

function checkdmz() {
	var f=document.getElementById("frm");
	var lanip, lanip_all;
	var dmzip = MathandAbs(f.dmz.value).split(".");
	var error=0;

	for(var i=0; i<2;i++) {
		lanip_all = eval("lan"+i);
		if(lanip_all == "N/A")
			continue;
		lanip = lanip_all.split(".");
		if((lanip[0] != dmzip[0])||(lanip[1] != dmzip[1])||(lanip[2] != dmzip[2])||evalIP(f.dmz.value)==lanip_all)
			error++;
	}
	if(error == 2)
		return false;
	else
		return true;	
}

function doSubmit() {	
	$("label[class='error']").html("");
	
   	var f=document.getElementById("frm");
	var str="";

   	if($("#dmz_choise_ck").attr("checked")) {
		$("#dmz_choise_value").val("1");
   		var inter = parseInt(f.inter.value);
		if( inter == 10 || inter == 8 ) {
			f.interface.value = f.service.value;
		} else {
			f.interface.value = inter;
		}
	   	
	   	if (checkParameter()) {		
			/*if($("#pf_Schedule").val() == "Always")
				$("#scheduleValue").val('-');
			else
				$("#scheduleValue").val($("#pf_Schedule").val());*/
		} 
		else {
			return;
		}		
	}
	else
		$("#dmz_choise_value").val("0");
	
	f.submitType.value = 'apply';

	document.getElementById("CreatePopAlertMessage").style.display = "inline";
	document.getElementById("waitSettingFinish").style.display = "inline";
	Start_reciprocal_Number_RestoreConfiguration();
	
	$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey){
		$("#sessionKey").val(sessionKey);	
		setTimeout('$.post("/cgi-bin/New_GUI/Dmz.asp", $("form").serialize(), function(){save_flag = true;});', 300);
	});	
}

function MathandAbs(ip) {
	var sIP=ip.split(".");
	absip = Math.abs(sIP[0])+"."+Math.abs(sIP[1])+"."+Math.abs(sIP[2])+"."+Math.abs(sIP[3]); 
	return absip;
}

function checkParameter() {
	var f=document.getElementById("frm");
	if(f.inter.value == "") {
		$("#inter_error").html("<br/>"+m_dmz_alert1);
		return false;
	}
	if (isBlank(f.dmz.value)||!is_valid_ip(f.dmz.value,0)) {
		dmzValue=f.dmz.value;
		$("#dmz_error").html("<br/>"+m_dmz_alert2);
		return false;
	} else {
	    if(checkdmz()==false) {
			dmzValue=f.dmz.value;
			$("#dmz_error").html("<br/>"+m_dmz_alert3);
			return false;
		}
	}
	return true;
}

function ChangState() {
	if($("#dmz_choise_ck").attr("checked")) {
		$("input[type='text']").removeAttr("disabled");
		$("#inter").selectbox("enable");
		$("#service").selectbox("enable");
		//$("#pf_Schedule").selectbox("enable");
	} 
	else {
		$("input[type='text']").attr("disabled", "disabled");
		$("#inter").selectbox("disable");
		$("#service").selectbox("disable");
		//$("#pf_Schedule").selectbox("disable");
	}	
}

function evalIP(ip) {
	var sIP=MathandAbs(ip).split(".");

	for(var i=0; i< sIP.length; i++)
		sIP[i]=parseInt(sIP[i],10);

	dIP = sIP[0]+"."+sIP[1]+"."+sIP[2]+"."+sIP[3];
	return dIP;	
}

function isNumber(n) {
	if (n.length==0) return false;
	for (var i=0;i < n.length;i++) {
		if (n.charAt(i) < '0' || n.charAt(i) > '9') return false;
	}
	return true;
}

function isBlank(s) {
	var i=0;
	for (i=0; i < s.length;i++) {
		if (s.charCodeAt(i)!=32) break;
	}
	if (i==s.length)
		return true;
	return false;
}

function getInterface() {
	var f = document.getElementById("inter");
	interface_list.length = 0;
	for(var i = 0; i < max_length; i++) {
		if(pvc_active[i] == "Yes" && pvc_enable[i] == "Enable") {
			var st = eval("dmz"+i+"_ip");
			if( (st == "") || (st == "N/A") || (st == "0.0.0.0") ) {
				f.options.add(new Option("PVC"+(i+1), i));
				interface_list.push(i); 
			}
		}
	}

	f.options.add(new Option("PTM", 8));
	//f.options.add(new Option("WAN", 10));	
}

function ChangeInterface() {	
	var f = document.getElementById("frm");
	$("#service").selectbox('detach');
	var ser = document.getElementById("service");
	ser.options.length = 0;
	
	switch(parseInt(f.inter.value)) {
		case 0:
		case 1:
		case 2:
		case 3:
		case 4:
		case 5:
		case 6:
		case 7: 
			document.getElementById("Service_Num").style.display = "none";
			break;
		case 8:			
			document.getElementById("Service_Num").style.display = "";
			for(var i = 0; i < max_length; i++) {
				if(wan8_pvc_active[i] == "Yes" && wan8_pvc_enable[i] == "Enable") {
					var st = eval("wan8_dmz"+i+"_ip");
					if( (st == "") || (st == "N/A") || (st == "0.0.0.0") ) {
						ser.options.add(new Option((i+1), i));
						wan8_service_list.push(i); 
					}
				}
			}
			$("#service").selectbox();
			break;
		case 10:
			document.getElementById("Service_Num").style.display = "";
			for(var i = 0; i < max_length; i++) {
				if(wan0_pvc_active[i] == "Yes" && wan0_pvc_enable[i] == "Enable") {
					var st = eval("wan0_dmz"+i+"_ip");
					if( (st == "") || (st == "N/A") || (st == "0.0.0.0") ) {
						ser.options.add(new Option((i+1), i));
						wan0_service_list.push(i); 
					}
				}
			}
			$("#service").selectbox();
			break;
	}
}

function gen_table() {
	var f = document.getElementById("frm");
	var table = new String();
	var table1 = new String();
	var str = new String();

	for(var i = 0; i < max_length; i++) {
		var dmz_ip = eval("dmz"+i+"_ip");
		if( (dmz_ip != "")  &&  (dmz_ip != "N/A") &&  (dmz_ip != "0.0.0.0") ) {
			str+="	<tr>";
			if(pvc_active[i] == "Yes" && pvc_enable[i] == "Enable") {
				if(eval("dmz"+i+"_active") == "Yes") 
					var act = m_comm_Active;
				else
					var act = m_comm_Inactive;
			} else {
				var act = m_comm_Inactive;
			}
			str+="		<td>"+act+"</td>";
			str+="		<td>PVC"+(i+1)+"</td>";
			str+="		<td>"+encodeSpecialChr(dmz_ip)+"</td>";
		
			/*if(eval("dmz"+i+"_schedule") == "-" ||eval("dmz"+i+"_schedule") == "" ||eval("dmz"+i+"_schedule") == "N/A")
				var tmpSchedule = "Always";
			else
				var tmpSchedule = eval("dmz"+i+"_schedule");
			str+="		<td>"+tmpSchedule+"</td>";*/

			str+='<td><img src="/graphic/New_GUI/edit_btn.gif" width=28 height=28 style="cursor:pointer" onclick="EditRow(0,'+i+')"/></td>';
			str+='<td>';
			str+='<img src="/graphic/New_GUI/trash.gif" width=41 height=41 style="cursor:pointer" onclick="deleteDate(0,'+i+')"/>';
			str+='<input type="hidden" id="enable_'+i+'" name="enable_'+i+'">';
			str+='</td>';
			str+="</tr>";

			Nempty++;
		}
	}

	for(var i = 0; i < max_length; i++) {
		var dmz_ip = eval("wan8_dmz"+i+"_ip");
		if( (dmz_ip != "")  &&  (dmz_ip != "N/A") &&  (dmz_ip != "0.0.0.0") ) {
			str+="	<tr>";
			if(wan8_pvc_active[i] == "Yes" && wan8_pvc_enable[i] == "Enable") {
				if(eval("wan8_dmz"+i+"_active") == "Yes") 
					var act = m_comm_Active;
				else
					var act = m_comm_Inactive;
			} else {
				var act = m_comm_Inactive;
			}
			str+="		<td>"+act+"</td>";
			str+="		<td>PTM</td>";
			str+="		<td>"+encodeSpecialChr(dmz_ip)+"</td>";
			
			/*if(eval("wan8_dmz"+i+"_schedule") == "-" ||eval("wan8_dmz"+i+"_schedule") == "" ||eval("wan8_dmz"+i+"_schedule") == "N/A")
				var tmpSchedule = "Always";
			else
				var tmpSchedule = eval("wan8_dmz"+i+"_schedule");
			str+="		<td>"+tmpSchedule+"</td>";*/
			
			str+='<td><img src="/graphic/New_GUI/edit_btn.gif" width=28 height=28 style="cursor:pointer" onclick="EditRow(1,'+i+')"/></td>';
			str+='<td>';
			str+='<img src="/graphic/New_GUI/trash.gif" width=41 height=41 style="cursor:pointer" onclick="deleteDate(1,'+i+')"/>';
			str+='<input type="hidden" id="wan8_enable_'+i+'" name="wan8_enable_'+i+'">';
			str+='</td>';
			str+="</tr>";
			Nempty++;
		}
	}

	for(var i = 0; i < max_length; i++) {
		var dmz_ip = eval("wan0_dmz"+i+"_ip");
		if( (dmz_ip != "")  &&  (dmz_ip != "N/A") &&  (dmz_ip != "0.0.0.0") ) {
			str+="	<tr>";
			if(wan0_pvc_active[i] == "Yes" && wan0_pvc_enable[i] == "Enable") {
				if(eval("wan0_dmz"+i+"_active") == "Yes") 
					var act = m_comm_Active;
				else
					var act = m_comm_Inactive;
			} else {
				var act = m_comm_Inactive;
			}
			str+="		<td>"+act+"</td>";
			str+="		<td>WAN</td>";
			str+="		<td>"+encodeSpecialChr(dmz_ip)+"</td>";
		
			/*if(eval("wan0_dmz"+i+"_schedule") == "-" ||eval("wan0_dmz"+i+"_schedule") == "" ||eval("wan0_dmz"+i+"_schedule") == "N/A")
				var tmpSchedule = "Always";
			else
				var tmpSchedule = eval("wan0_dmz"+i+"_schedule");
			str+="		<td>"+tmpSchedule+"</td>";*/
			
			str+='<td><img src="/graphic/New_GUI/edit_btn.gif" width=28 height=28 style="cursor:pointer" onclick="EditRow(2,'+i+')"/></td>';
			str+='<td>';
			str+='<img src="/graphic/New_GUI/trash.gif" width=41 height=41 style="cursor:pointer" onclick="deleteDate(2,'+i+')"/>';
			str+='<input type="hidden" id="wan0_enable_'+i+'" name="wan0_enable_'+i+'">';
			str+='</td>';
			str+="</tr>";
			Nempty++;
		}
	}

	document.write(str);
}

function deleteDate(j,i) {
	var f = document.getElementById("frm");
	if(parseInt(j) == 0)
		var st = eval("f.enable_"+i);
	else if(parseInt(j) == 1)
		var st = eval("f.wan8_enable_"+i);
	else
		var st = eval("f.wan0_enable_"+i);
	
	st.value = 1;

	f.submitType.value = 'delete';
	
	if(confirm(m_dmz_del)) {
		$("#buttonType").val("delete");

		document.getElementById("CreatePopAlertMessage").style.display = "inline";
		document.getElementById("waitSettingFinish").style.display = "inline";
		Start_reciprocal_Number_RestoreConfiguration();
		
		$.get("/cgi-bin/get/New_GUI/get_sessionKey.asp", function(sessionKey){
			$("#sessionKey").val(sessionKey);	
			setTimeout('$.post("/cgi-bin/New_GUI/Dmz.asp", $("form").serialize(), function(){save_flag = true;});', 300);
		});
	}
}

function EditRow(j,i) {
	var f = document.getElementById("frm");
	
	createEditButton();	

	$("#editFlag").val(1);
	$("#editNo").val(i);
	$("#interface").val(i);
	$("#eth_flag").val(j);

	ChangeInterface();

	var inter_list = copyArray(interface_list);
	var ptm_list = copyArray(wan8_service_list);
	var eth_list = copyArray(wan0_service_list);

	if(parseInt(j) == 0) {
		inter_list.push(i);
		inter_list = BubbleSort(inter_list);
	} else if(parseInt(j) == 1) {
		ptm_list.push(i);
		ptm_list = BubbleSort(ptm_list);
	} else {
		eth_list.push(i);
		eth_list = BubbleSort(eth_list);
	}
	
	f.inter.options.length = 0;		
	for(var z = 0; z < inter_list.length; z++) {
		f.inter.options.add(new Option("PVC"+(inter_list[z]+1), inter_list[z]));
	}
	f.inter.options.add(new Option("PTM", 8));
	//f.inter.options.add(new Option("WAN", 10));
	$("#inter").selectbox();

	$("#service").selectbox('detach');
	f.service.options.length = 0;
	if(parseInt(j) == 1) {		
		for(var z = 0; z < ptm_list.length; z++) {			
			f.service.options.add(new Option((ptm_list[z]+1), ptm_list[z]));
		}	
	}
	if(parseInt(j) == 2) {		
		for(var z = 0; z < eth_list.length; z++) {			
			f.service.options.add(new Option((eth_list[z]+1), eth_list[z]));
		}		
	}		

	if(parseInt(j) == 0) {
		var dmz_active = eval("dmz"+i+"_active");
		var dmz_ip = eval("dmz"+i+"_ip");	
		var dmz_schedule = eval("dmz"+i+"_schedule"); 		
	} 
	else if(parseInt(j) == 1){
		var dmz_active = eval("wan8_dmz"+i+"_active");
		var dmz_ip = eval("wan8_dmz"+i+"_ip");	
		var dmz_schedule = eval("wan8_dmz"+i+"_schedule");		
	} 
	else {
		var dmz_active = eval("wan0_dmz"+i+"_active");
		var dmz_ip = eval("wan0_dmz"+i+"_ip");
		var dmz_schedule = eval("wan0_dmz"+i+"_schedule");	
	}
	
	if(dmz_active == "Yes")
		SetCheckBoxEnable("dmz_choise", true, true);
	else
		SetCheckBoxEnable("dmz_choise", true, false);
	
	if(parseInt(j) == 0) {		
		$("#inter").selectbox("detach");
		$("#inter").val(i);
		$("#inter").selectbox("attach");
		document.getElementById("Service_Num").style.display = "none";
	} 
	else if(parseInt(j) == 1){		
		$("#inter").selectbox("detach");
		$("#inter").val(8);
		$("#inter").selectbox("attach");		
		$("#service").val(i);		
		$("#service").selectbox();
		document.getElementById("Service_Num").style.display = "";
	} 
	else {		
		$("#inter").selectbox("detach");
		$("#inter").val(10);
		$("#inter").selectbox("attach");
		$("#service").val(i);
		$("#service").selectbox();
		document.getElementById("Service_Num").style.display = "";
	}	

	$("#dmz").val(dmz_ip);

	/*if(dmz_schedule == "-"){
		$("#pf_Schedule").val("Always");
		$('#pf_Schedule').selectbox('change', $("#pf_Schedule").val(), $("#pf_Schedule").find('option:selected').text());
	}
	else{
		$("#pf_Schedule").val(dmz_schedule);
		$('#pf_Schedule').selectbox('change', $("#pf_Schedule").val(), $("#pf_Schedule").find('option:selected').text());
	}*/
	
	ChangState();
}

function copyArray(arr) {
	var newArr = new Array();
	for(var i = 0; i < arr.length; i++) {
		newArr.push(arr[i]);
	}
	return newArr;
}

function BubbleSort(arr) {
	var temp;
	var exchange;
 	for(var i=0; i<arr.length; i++) {
		exchange = false;
		for(var j=arr.length-2; j>=i; j--) {
			if((arr[j+1]) < (arr[j])) {
				temp = arr[j+1];
				arr[j+1] = arr[j];
				arr[j] = temp;
				exchange = true;
			}
		}
		if(!exchange) break;
	}
 	return arr;
}

function createEditButton()
{
	$("#popTitle").html(m_comm_createnew);
	document.getElementById("createPop").style.display = "inline";
	document.getElementById("createButton").disabled = true;
	$("#frm").val(-1);	
}

function createUserButton()
{
	$("#popTitle").html(m_comm_createnew);
	document.getElementById("createPop").style.display = "inline";
	document.getElementById("createButton").disabled = true;
	$("#frm").val(-1);	
	initPop();	
}

function initPop(){	
	var f = document.getElementById("frm");
	$("#editFlag").val(0);	

	f.inter.options.length = 0;
	getInterface();
	$("#inter").selectbox();
	
	SetCheckBoxEnable("dmz_choise", true, true);
	
	if($("#conn_type").val() == "Ethernet"){
		$("#inter").val(10);
		$('#inter').selectbox('change', $("#inter").val(), $("#inter").find('option:selected').text());
	}
	if($("#conn_type").val() == "PTM"){
		$("#inter").val(8);
		$('#inter').selectbox('change', $("#inter").val(), $("#inter").find('option:selected').text());
	}

	ChangeInterface();		
	
	$("input[type='text']").val('');
	
	/*$("#pf_Schedule").val('Always');
	$('#pf_Schedule').selectbox('change', $("#pf_Schedule").val(), $("#pf_Schedule").find('option:selected').text());*/

	ChangState();
	hideSaveBtn();	
}

function resetRulePOP()
{	
	$("#inter").selectbox('detach');
	$("#service").selectbox('detach');
	document.getElementById("createPop").style.display = "none";
}

function check_TotalRule(maxRule, totalRule)
{
	var IsFull = maxRule - totalRule;
	document.getElementById("RemainingRules").innerHTML = IsFull;
	
	if (IsFull == 0)
	{
		document.getElementById("createButton").setAttribute("class", "styled_button_dis");
		document.getElementById("createButton").disabled = true;
	}
	else
	{
		document.getElementById("createButton").setAttribute("class", "styled_button_s");
		document.getElementById("createButton").disabled = false;
	}
}

function clearCreateRulePOP()
{
	resetRulePOP();
	$("input[type='text']").val("");
	$("label[class='error']").html("");
	$(':text').prop('className', 'styled-text');
	check_TotalRule(max_length, Nempty);
}

function changeDmz(){
	SetCheckBoxEnable("dmz_choise");
	hideSaveBtn();
}

var save_flag = false;
var _ReciprocalNumber = 10;
function Start_reciprocal_Number_RestoreConfiguration() {
	if (_ReciprocalNumber >= 0) {
		document.getElementById("reciprocal_Number").innerHTML = _ReciprocalNumber + " Sec";
		_ReciprocalNumber --;
		setTimeout("Start_reciprocal_Number_RestoreConfiguration()", 1000);
	} else {
		if(save_flag) {
			document.getElementById("waitSettingFinish").style.display = "none";
			document.getElementById("SuccessSettings").style.display = "inline";
		} else {
			setTimeout("Start_reciprocal_Number_RestoreConfiguration()", 1000);
		}
	}
}