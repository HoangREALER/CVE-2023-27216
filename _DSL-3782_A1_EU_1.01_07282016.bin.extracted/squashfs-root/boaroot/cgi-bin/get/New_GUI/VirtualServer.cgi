#!/bin/sh
echo -e "Content-Type: text/html\n\n"
tcapi_path=/userfs/bin/

nat_pvc=`"$tcapi_path"tcapi get WebCurSet_Entry nat_pvc`
nat_pvc=`"$tcapi_path"alpha_tcapi $nat_pvc`
nat_pvc_ext=`"$tcapi_path"tcapi get WebCurSet_Entry nat_pvc_ext`
nat_pvc_ext=`"$tcapi_path"alpha_tcapi $nat_pvc_ext`

nat_flag="0"
nat_pvca="-1"
nat_pvc8="-1"
nat_pvc8_ext="-1"
nat_pvc10="-1"
nat_pvc10_ext="-1"

for i in 0 1 2 3 4 5 6 7
do
	node_name="Wan_PVC"$i""
	pvc_enable=`"$tcapi_path"tcapi get $node_name NATENABLE`
	pvc_enable=`"$tcapi_path"alpha_tcapi $pvc_enable`
	pvc_active=`"$tcapi_path"tcapi get $node_name Active`
	pvc_active=`"$tcapi_path"alpha_tcapi $pvc_active`
	case $pvc_enable in "no node information" | "no attribute information" | "connection error") pvc_enable="N/A"
	esac
	case $pvc_active in "no node information" | "no attribute information" | "connection error") pvc_active="N/A"
	esac
	ECHOCMD="$ECHOCMD  PVC"$i"_Enable = '"$pvc_enable"';"
	ECHOCMD="$ECHOCMD  PVC"$i"_active = '"$pvc_active"';"

	if [ "$nat_pvca" = "-1" ]; then
		if [ "$pvc_active" = "Yes" -a "$pvc_enable" = "Enable" ]; then
			nat_pvca="$i"
		fi
	fi	

	if [ "$nat_pvc" = "$i" ]; then
		if [ "$pvc_active" = "Yes" -a "$pvc_enable" = "Enable" ]; then
			nat_flag="1"
		fi
	fi

	node_name="WanExt_PVC8e"$i""
	pvc_enable=`"$tcapi_path"tcapi get $node_name NATENABLE`
	pvc_enable=`"$tcapi_path"alpha_tcapi $pvc_enable`
	pvc_active=`"$tcapi_path"tcapi get $node_name Active`
	pvc_active=`"$tcapi_path"alpha_tcapi $pvc_active`
	case $pvc_enable in "no node information" | "no attribute information" | "connection error") pvc_enable="N/A"
	esac
	case $pvc_active in "no node information" | "no attribute information" | "connection error") pvc_active="N/A"
	esac
	ECHOCMD="$ECHOCMD  WAN8_PVC"$i"_Enable = '"$pvc_enable"';"
	ECHOCMD="$ECHOCMD  WAN8_PVC"$i"_active = '"$pvc_active"';"

	if [ "$nat_pvc8" = "-1" ]; then
		if [ "$pvc_active" = "Yes" -a "$pvc_enable" = "Enable" ]; then
			nat_pvc8="8"
			nat_pvc8_ext="$i"
		fi
	fi

	if [ "$nat_pvc" = "8" ]; then
		if [ "$pvc_active" = "Yes" -a "$pvc_enable" = "Enable" ]; then
			nat_flag="1"
		fi
	fi

	node_name="WanExt_PVC10e"$i""
	pvc_enable=`"$tcapi_path"tcapi get $node_name NATENABLE`
	pvc_enable=`"$tcapi_path"alpha_tcapi $pvc_enable`
	pvc_active=`"$tcapi_path"tcapi get $node_name Active`
	pvc_active=`"$tcapi_path"alpha_tcapi $pvc_active`
	case $pvc_enable in "no node information" | "no attribute information" | "connection error") pvc_enable="N/A"
	esac
	case $pvc_active in "no node information" | "no attribute information" | "connection error") pvc_active="N/A"
	esac
	ECHOCMD="$ECHOCMD  WAN10_PVC"$i"_Enable = '"$pvc_enable"';"
	ECHOCMD="$ECHOCMD  WAN10_PVC"$i"_active = '"$pvc_active"';"

	if [ "$nat_pvc10" = "-1" ]; then
		if [ "$pvc_active" = "Yes" -a "$pvc_enable" = "Enable" ]; then
			nat_pvc10="10"
			nat_pvc10_ext="$i"
		fi
	fi

	if [ "$nat_pvc" = "10" ]; then
		if [ "$pvc_active" = "Yes" -a "$pvc_enable" = "Enable" ]; then
			nat_flag="1"
		fi
	fi
done

if [ "$nat_flag" = "0" ]; then
	if [ "$nat_pvca" != "-1" ]; then
		nat_pvc="$nat_pvca"
		`"$tcapi_path"tcapi set WebCurSet_Entry nat_pvc $nat_pvca`
	elif [ "$nat_pvc8" != "-1" ]; then
		nat_pvc="$nat_pvc8"
		nat_pvc_ext="$nat_pvc8_ext"
		`"$tcapi_path"tcapi set WebCurSet_Entry nat_pvc $nat_pvc8`
		`"$tcapi_path"tcapi set WebCurSet_Entry nat_pvc_ext $nat_pvc8_ext`
	elif [ "$nat_pvc10" != "-1" ]; then
		nat_pvc="$nat_pvc10"
		nat_pvc_ext="$nat_pvc10_ext"
		`"$tcapi_path"tcapi set WebCurSet_Entry nat_pvc $nat_pvc10`
		`"$tcapi_path"tcapi set WebCurSet_Entry nat_pvc_ext $nat_pvc10_ext`
	else
		nat_pvc="$nat_pvc"
		nat_pvc_ext="$nat_pvc_ext"
	fi
fi

for i in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63
do
	node_name=""
	if [ "$nat_pvc" = "8"  ]; then
		node_name="VirServerExt_PVC8e"$nat_pvc_ext"_Entry"$i""
	elif  [ "$nat_pvc" = "10"  ]; then
		node_name="VirServerExt_PVC10e"$nat_pvc_ext"_Entry"$i""
	else
		node_name="VirServer_PVC"$nat_pvc"_Entry"$i""
	fi
	virtual_LOCALIP=`"$tcapi_path"tcapi get $node_name LOCALIP`
	virtual_LOCALIP=`"$tcapi_path"alpha_tcapi $virtual_LOCALIP`

	if [ "$virtual_LOCALIP" = "no node information" -o "$virtual_LOCALIP" = "0.0.0.0" -o "$virtual_LOCALIP" = "no attribute information" -o "$virtual_LOCALIP" = "connection error" ]; then
		continue
	else
		virtual_Active=`"$tcapi_path"tcapi get $node_name Active`
		virtual_Active=`"$tcapi_path"alpha_tcapi $virtual_Active`
		virtual_name=`"$tcapi_path"tcapi get $node_name Name`		
		virtual_name=`"$tcapi_path"alpha_tcapi $virtual_name`
		virtual_LOCAL_SPORT=`"$tcapi_path"tcapi get $node_name LOCAL_SPORT`
		virtual_LOCAL_SPORT=`"$tcapi_path"alpha_tcapi $virtual_LOCAL_SPORT`
		virtual_LOCAL_EPORT=`"$tcapi_path"tcapi get $node_name LOCAL_EPORT`
		virtual_LOCAL_EPORT=`"$tcapi_path"alpha_tcapi $virtual_LOCAL_EPORT`
		virtual_STARTPORT=`"$tcapi_path"tcapi get $node_name STARTPORT`
		virtual_STARTPORT=`"$tcapi_path"alpha_tcapi $virtual_STARTPORT`
		virtual_ENDPORT=`"$tcapi_path"tcapi get $node_name ENDPORT`
		virtual_ENDPORT=`"$tcapi_path"alpha_tcapi $virtual_ENDPORT`
		virtual_PROTOCOL=`"$tcapi_path"tcapi get $node_name PROTOCOL`
		virtual_PROTOCOL=`"$tcapi_path"alpha_tcapi $virtual_PROTOCOL`
		virtual_Schedule=`"$tcapi_path"tcapi get $node_name SCH`
		virtual_Schedule=`"$tcapi_path"alpha_tcapi $virtual_Schedule`

		ECHOCMD="$ECHOCMD  virtual"$i"name = '"$virtual_name"';"
		ECHOCMD="$ECHOCMD  virtual"$i"active = '"$virtual_Active"';"
		ECHOCMD="$ECHOCMD  virtual"$i"localip = '"$virtual_LOCALIP"';"
		ECHOCMD="$ECHOCMD  virtual"$i"local_sport = '"$virtual_LOCAL_SPORT"';"
		ECHOCMD="$ECHOCMD  virtual"$i"local_eport = '"$virtual_LOCAL_EPORT"';"
		ECHOCMD="$ECHOCMD  virtual"$i"startport = '"$virtual_STARTPORT"';"
		ECHOCMD="$ECHOCMD  virtual"$i"endport = '"$virtual_ENDPORT"';"
		ECHOCMD="$ECHOCMD  virtual"$i"protocol = '"$virtual_PROTOCOL"';"
		ECHOCMD="$ECHOCMD  virtual"$i"schedule = '"$virtual_Schedule"';"		
	fi
done

node_name="Lan_Entry0"
lan_ip=`"$tcapi_path"tcapi get $node_name IP`
lan_ip=`"$tcapi_path"alpha_tcapi $lan_ip`
case $lan_ip in "no node information" | "no attribute information" | "connection error") lan_ip="N/A"
esac
ECHOCMD="$ECHOCMD  lan0 = '"$lan_ip"';"

node_name="LanAlias_Entry"
lan_ip=`"$tcapi_path"tcapi get $node_name IP`
lan_ip=`"$tcapi_path"alpha_tcapi $lan_ip`
case $lan_ip in "no node information" | "no attribute information" | "connection error") lan_ip="N/A"
esac
ECHOCMD="$ECHOCMD  lan1 = '"$lan_ip"';"

ACL_All_Active="0"
ACL_Common=`"$tcapi_path"tcapi get ACL_Common Activate`
ACL_Common=`"$tcapi_path"alpha_tcapi $ACL_Common`
if [ "$ACL_Common" = "Yes"  ]; then
	for i in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
	do 
		node_name="ACL_Entry"$i""
		ACL_Active=`"$tcapi_path"tcapi get $node_name Activate`
		ACL_Active=`"$tcapi_path"alpha_tcapi $ACL_Active`
		ACL_Interface=`"$tcapi_path"tcapi get $node_name Interface`
		ACL_Interface=`"$tcapi_path"alpha_tcapi $ACL_Interface`
		if [ "$ACL_Active" = "Yes"  ]; then
			if [ "$ACL_Interface" = "WAN" -o "$ACL_Interface" = "Both" ]; then
				ACL_All_Active="1"
			fi
		fi
	done
fi

ECHOCMD="$ECHOCMD  ACL_All_Active = '"$ACL_All_Active"';"

ECHOCMD="$ECHOCMD  nat_pvc = '"$nat_pvc"';"
ECHOCMD="$ECHOCMD  nat_pvc_ext = '"$nat_pvc_ext"';"

echo $ECHOCMD


CommonNum=`/userfs/bin/tcapi get Info_UpnpRule_Common Num`
CommonNum=`/userfs/bin/alpha_tcapi $CommonNum`
echo "var upnp_CommonNum = parseInt('"$CommonNum"');"

i=0
while [ $i -ne $CommonNum ]  
do  
	node_name="Info_UpnpRule_Entry"$i
	DestPort=`/userfs/bin/tcapi get $node_name DestPort`
	DestPort=`/userfs/bin/alpha_tcapi $DestPort`
	SourceIP=`/userfs/bin/tcapi get $node_name SourceIP`
	SourceIP=`/userfs/bin/alpha_tcapi $SourceIP`
	SourcePort=`/userfs/bin/tcapi get $node_name SourcePort`
	SourcePort=`/userfs/bin/alpha_tcapi $SourcePort`
	Protocol=`/userfs/bin/tcapi get $node_name Protocol`
	Protocol=`/userfs/bin/alpha_tcapi $Protocol`	
	
	case "$DestPort" in
        "no attribute information" | "no node information" )
		DestPort="N/A";;
	esac
	case "$SourceIP" in
	"no attribute information" | "no node information" )
		SourceIP="N/A";;
	esac
	case "$SourcePort" in
	"no attribute information" | "no node information" )
		SourcePort="N/A";;
	esac

	case "$Protocol" in
	"no attribute information" | "no node information" )
		Protocol="N/A";;
	esac

	echo "var upnpRule"$i"_dport = '"$DestPort"';"
	echo "var upnpRule"$i"_sip = '"$SourceIP"';"
	echo "var upnpRule"$i"_sport = '"$SourcePort"';"
	echo "var upnpRule"$i"_protocol = '"$Protocol"';"

	i=`expr $i + 1`
done